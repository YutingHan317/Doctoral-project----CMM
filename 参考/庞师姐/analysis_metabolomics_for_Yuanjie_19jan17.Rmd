---
title: "Metabolomics"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
date: "21 December 2016"
---

```{r, echo = FALSE, include = FALSE}
library(knitr)
opts_chunk$set(fig.width = 7.5, fig.height = 5.5, echo = FALSE, eval = TRUE, message = FALSE, warning = FALSE, cache = FALSE, fig.align = "left", sanitize = TRUE, error = TRUE)
# opts_chunk$set(fig.width = 5.5, fig.height = 4.5, echo = FALSE, eval = TRUE, message = FALSE, warnings = FALSE, cache = TRUE)
```

<!--
START
-->

```{r}
# setwd("")

## rm(list=ls(all=TRUE))

load("data_biochemistry_isoforms_metabolomics_merged_clean_28jun16.RData")
# load("data_biochemistry_isoforms_metabolomics_merged_clean_21jun16.RData")
## load("data_biochemistry_isoforms_metabolomics_merged_clean_20jun16.RData")
### load("data_biochemistry_isoforms_metabolomics_merged_20jun16.RData")
### load("data_biochemistry_isoforms_metabolomics_merged_23may16.RData")

load("labels_dataframe_13may15.RData")

################################################

values <- data[,grep("result", names(data))]

# dim(values)
```

Number of individuals and variables in the data

```{r}
dim(data)
```

## Ascertainment by first event in all data

```{r}
table("first event" = data$first_event, "ascertainment" = data$type, useNA = "ifany")
```

## Ascertainment by first event in all individuals with baseline biochemistry

```{r}
table("first event" = data[which(data$has_biochem == 1),]$first_event, "ascertainment" = data[which(data$has_biochem == 1),]$type, useNA = "ifany")
```

```{r, eval = FALSE}
# 11jan17
# list of biochemistry LIMS for Robin
list1 <- data[which(data$has_biochem_resurvey1 == 1 | data$has_biochem_resurvey2 == 1), c("studyid", "has_biochem", "has_biochem_resurvey1", "has_biochem_resurvey2", "has_metabolomics", "has_metabolomics_resurvey1", "has_metabolomics_resurvey2"),]
dim(list1) # 1698    7
# write.csv(list1, file = "list_LIMS_resurvey_for_Robin_11jan17.csv", row.names = FALSE)
```

## Ascertainment by first event in all individuals with baseline metabolomics

```{r}
table("first event" = data[which(data$has_metabolomics == 1),]$first_event, "ascertainment" = data[which(data$has_metabolomics == 1),]$type, useNA = "ifany")
```

## Ascertainment by first event in all individuals with isoforms

```{r}
table("first event" = data[which(data$has_isoforms == 1),]$first_event, "ascertainment" = data[which(data$has_isoforms == 1),]$type, useNA = "ifany")
```

<!--
## Ascertainment by current status in all data

```{r}
table("ascertainment" = data$type, "current status" = data$cat, useNA = "ifany")
```

## Ascertainment by current status in all individuals with baseline biochemistry

```{r}
table("ascertainment" = data[which(data$has_biochem == 1),]$type, "current status" = data[which(data$has_biochem == 1),]$cat, useNA = "ifany")
```

## Ascertainment by current status in all individuals with metabolomics

```{r}
table("ascertainment" = data[which(data$has_metabolomics == 1),]$type, "current status" = data[which(data$has_metabolomics == 1),]$cat, useNA = "ifany")
```
-->

--------------------------------------------------------

# Analysis

```{r}
# Status used in the analysis
data$status <- NA
data[which(data$first_event == "control"),]$status <- "control"
data[which(data$first_event == "HS"),]$status <- "HS"
data[which(data$first_event == "IS"),]$status <- "IS"
data[which(data$first_event == "MI"),]$status <- "MI"
# table(data$status, useNA = "ifany")
# control      HS      IS      MI    <NA> 
#    7461    4577    5441    1028     454 
```

## Correlation between baseline and resurvey

There are `r length(which(data$has_metabolomics == 1))` individuals with metabolomics at baseline.  
There are `r length(which(data$has_metabolomics_resurvey1 == 1))` individuals with metabolomics at 1st resurvey.  
There are `r length(which(data$has_metabolomics_resurvey2 == 1))` individuals with metabolomics at 2nd resurvey.  

There are `r length(which(data$has_metabolomics == 1 & data$has_metabolomics_resurvey1 == 1))` individuals with metabolomics at baseline and 1st resurvey.  
There are `r length(which(data$has_metabolomics_resurvey1 == 1 & data$has_metabolomics_resurvey2 == 1))` individuals with metabolomics at 1st and 2nd resurvey.  
There are `r length(which(data$has_metabolomics == 1 & data$has_metabolomics_resurvey1 == 1 & data$has_metabolomics_resurvey2 == 1))` individuals with all three.  

```{r}
b <- 411:635
b1 <- 651:875
b2 <- 889:1113

load("../metabolomics/metabolomics_labels_9sep15.RData")

# cor_table <- data.frame("metabolite" = sapply(names(data)[b], function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = "")), "mean_baseline" = apply(data[,b], 2, mean, na.rm = TRUE), "sd_baseline" = apply(data[,b], 2, sd, na.rm = TRUE), "mean_resurvey1" = apply(data[,b1], 2, mean, na.rm = TRUE), "sd_resurvey1" = apply(data[,b1], 2, sd, na.rm = TRUE), "mean_resurvey2" = apply(data[,b2], 2, mean, na.rm = TRUE), "sd_resurvey2" = apply(data[,b2], 2, sd, na.rm = TRUE), "cor_baseline_resurvey1" = diag(cor(data[,b], data[,b1], use = "pairwise.complete.obs")), "cor_baseline_resurvey2" = diag(cor(data[,b], data[,b2], use = "pairwise.complete.obs")), "cor_resurvey1_resurvey2" = diag(cor(data[,b1], data[,b2], use = "pairwise.complete.obs")))

cor_table <- data.frame("metabolite" = sapply(names(data)[b], function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = "")), "mean_baseline" = apply(data[,b], 2, mean, na.rm = TRUE), "sd_baseline" = apply(data[,b], 2, sd, na.rm = TRUE), "mean_resurvey1" = apply(data[,b1], 2, mean, na.rm = TRUE), "sd_resurvey1" = apply(data[,b1], 2, sd, na.rm = TRUE), "mean_resurvey2" = apply(data[,b2], 2, mean, na.rm = TRUE), "sd_resurvey2" = apply(data[,b2], 2, sd, na.rm = TRUE), "cor_baseline_resurvey1" = diag(cor(data[,b], data[,b1], use = "complete.obs")), "cor_baseline_resurvey2" = diag(cor(data[,b], data[,b2], use = "complete.obs")))
# write.csv(cor_table, file = "cor_table_metabolomics_baseline_resurveys_5oct16.csv")

kable(cor_table, digits = 2)
```

```{r}
# keep only individuals with baseline metabolomics
data <- data[which(data$has_metabolomics == 1),]
```

There are `r dim(data)[1]` individuals.

Status used in the analysis:

```{r}
table(data$status, useNA = "ifany")
```

<!--
Duplicate status by status used in the analysis:

```{r}
table(data$duplicated_metab_baseline, data$status, useNA = "ifany")
# table(data[which(data$duplicated_metab_baseline == 0),]$status, useNA = "ifany")
```
-->

Those with 'missing' status are removed.

```{r}
data <- data[which(!is.na(data$status)),]
```

There are `r dim(data)[1]` individuals used in the analysis. There are `r length(unique(data$studyid))` unique individuals.

```{r}
# age in 5-year groups
data$age_cat5 <- cut(data$age_at_study_date, seq(30, 75, by = 5), right = FALSE)
table(data$age_cat5)
# [30,35) [35,40) [40,45) [45,50) [50,55) [55,60) [60,65) [65,70) [70,75) 
#     145     984    1257     767     838     676     252      42      22 

# data$age_cat5 <- cut(data$age_at_study_date, seq(30, 80, by = 5), right = FALSE)
# table(data$age_cat5)
# [30,35) [35,40) [40,45) [45,50) [50,55) [55,60) [60,65) [65,70) [70,75) [75,80) 
#     145     984    1257     767     838     676     252      42      22       0 

data$region_code <- data$region_code.y
data$is_female <- data$is_female.y

#  No formal school
#  Primary School
#  Middle School
#  High School
#  Technical school / college
#  University

# education combined
data$education_combined <- NA
data[which(data$highest_education == 0 | data$highest_education == 1),]$education_combined <- "1_No formal school / Primary school"
data[which(data$highest_education == 2 | data$highest_education == 3),]$education_combined <- "2_Middle school / High school"
data[which(data$highest_education == 4 | data$highest_education == 5),]$education_combined <- "3_Technical school/college / University"
# table(data$education_combined, data$highest_education, useNA = "ifany")
```

<!--
The adjustment methods include the Bonferroni correction ("bonferroni") in which the p-values are multiplied by the number of comparisons. Less conservative corrections are also included by Holm (1979) ("holm"), Hochberg (1988) ("hochberg"), Hommel (1988) ("hommel"), Benjamini & Hochberg (1995) ("BH" or its alias "fdr"), and Benjamini & Yekutieli (2001) ("BY"), respectively. A pass-through option ("none") is also included. The set of methods are contained in the p.adjust.methods vector for the benefit of methods that need to have the method as an option and pass it on to p.adjust.

The first four methods are designed to give strong control of the family-wise error rate. There seems no reason to use the unmodified Bonferroni correction because it is dominated by Holm's method, which is also valid under arbitrary assumptions.

Hochberg's and Hommel's methods are valid when the hypothesis tests are independent or when they are non-negatively associated (Sarkar, 1998; Sarkar and Chang, 1997). Hommel's method is more powerful than Hochberg's, but the difference is usually small and the Hochberg p-values are faster to compute.

The "BH" (aka "fdr") and "BY" method of Benjamini, Hochberg, and Yekutieli control the false discovery rate, the expected proportion of false discoveries amongst the rejected hypotheses. The false discovery rate is a less stringent condition than the family-wise error rate, so these methods are more powerful than the others.

Note that you can set n larger than length(p) which means the unobserved p-values are assumed to be greater than all the observed p for "bonferroni" and "holm" methods and equal to 1 for the other methods.
-->

```{r, eval = FALSE}
# Principal components analysis
b <- 411:635
pca <- prcomp(data[,b][complete.cases(apply(data[,b], 2, function(x) x/sd(x, na.rm = TRUE))),])
summary(pca)
# the 18 first PCs explain >95% of the variance
```

## Logistic regression

Logistic regression of status on metabolite, adjusted for age (in 5-year groups), sex, region, smoking, education and fasting status

```{r}
# overall sd for each metabolite
b <- 411:635
sd_overall <- apply(data[,b], 2, sd, na.rm = TRUE)
```

### Haemorrhagic stroke

```{r}
####################################################################################
# haemorrhagic stroke
####################################################################################

haemorrhagic_stroke <- data[which(data$status == "HS" | data$status == "control"),]
haemorrhagic_stroke$case <- NA
haemorrhagic_stroke$case[which(haemorrhagic_stroke$status == "control")] <- 0
haemorrhagic_stroke$case[which(haemorrhagic_stroke$status == "HS")] <- 1
table(haemorrhagic_stroke$case, useNA = "ifany")

####################################################################################

b <- 411:635
# names(data)[b]

# standardize values such that odds ratios are for each increase in one standard deviation
values_haemorrhagic_stroke <- haemorrhagic_stroke[,b]
for (i in 1:length(b)) {
  values_haemorrhagic_stroke[,i] <- values_haemorrhagic_stroke[,i] / sd_overall[i]
  }
# values_haemorrhagic_stroke <- apply(haemorrhagic_stroke[,b], 2, function(x) x/sd(x, na.rm = TRUE))

####################################################################################

# logistic regression adjusting for age (in 5-year groups), sex, region, education and fasting status
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_haemorrhagic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8), data = haemorrhagic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_haemorrhagic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(haemorrhagic_stroke[which(!is.na(apply(data.frame(values_haemorrhagic_stroke[,i], as.numeric(haemorrhagic_stroke$age_cat5), haemorrhagic_stroke$region_code, as.numeric(haemorrhagic_stroke$is_female)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_HS_adj_age5_sex_region_smoking_education_fasting_14dec16.RData"
# load(filename)

# jpeg("lr_HS_adj_age5_sex_region_smoking_education_fasting_transformed_p_28jun16.jpeg", quality = 100)
# pdf("lr_HS_adj_age5_sex_region_smoking_education_fasting_transformed_p_28jun16.pdf")
plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
    n <- length(p)
    o <- ordered_values(n)
    plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
#    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], adj = c(1, 1), cex = 0.7, col = "orchid4")
	}

# jpeg("lr_HS_adj_age5_sex_region_smoking_education_fasting_transformed_p_text_28jun16.jpeg", quality = 100)
plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()
```

### Ischaemic stroke

```{r}
####################################################################################
# ischaemic stroke
####################################################################################

ischaemic_stroke <- data[which(data$status == "IS" | data$status == "control"),]
ischaemic_stroke$case <- NA
ischaemic_stroke$case[which(ischaemic_stroke$status == "control")] <- 0
ischaemic_stroke$case[which(ischaemic_stroke$status == "IS")] <- 1
table(ischaemic_stroke$case, useNA = "ifany")

####################################################################################

b <- 411:635
# names(data)[b]

# standardize values such that odds ratios are for each increase in one standard deviation
values_ischaemic_stroke <- ischaemic_stroke[,b]
for (i in 1:length(b)) {
  values_ischaemic_stroke[,i] <- values_ischaemic_stroke[,i] / sd_overall[i]
  }
# values_ischaemic_stroke <- apply(ischaemic_stroke[,b], 2, function(x) x/sd(x, na.rm = TRUE))

####################################################################################

# logistic regression adjusting for age (in 5-year groups), sex, region, education and fasting status
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_ischaemic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8), data = ischaemic_stroke, family = "binomial"))
  names(fit)[i] <- colnames(values_ischaemic_stroke)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(ischaemic_stroke[which(!is.na(apply(data.frame(values_ischaemic_stroke[,i], as.numeric(ischaemic_stroke$age_cat5), ischaemic_stroke$region_code, as.numeric(ischaemic_stroke$is_female)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_IS_adj_age5_sex_region_smoking_education_fasting_14dec16.RData"
# load(filename)

# jpeg("lr_IS_adj_age5_sex_region_smoking_education_fasting_transformed_p_28jun16.jpeg", quality = 100)
# pdf("lr_IS_adj_age5_sex_region_smoking_education_fasting_transformed_p_28jun16.pdf")
plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
  #    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], adj = c(1, 1), cex = 0.7, col = "orchid4")
}

# jpeg("lr_IS_adj_age5_sex_region_smoking_education_fasting_transformed_p_text_20jun16.jpeg", quality = 100)
plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()
```

### Myocardial infarction

```{r}
####################################################################################
# myocardial infarction
####################################################################################

myocardial_infarction <- data[which(data$status == "MI" | data$status == "control"),]
myocardial_infarction$case <- NA
myocardial_infarction$case[which(myocardial_infarction$status == "control")] <- 0
myocardial_infarction$case[which(myocardial_infarction$status == "MI")] <- 1
table(myocardial_infarction$case, useNA = "ifany")

####################################################################################

b <- 411:635
# names(data)[b]

# standardize values such that odds ratios are for each increase in one standard deviation
values_myocardial_infarction <- myocardial_infarction[,b]
for (i in 1:length(b)) {
  values_myocardial_infarction[,i] <- values_myocardial_infarction[,i] / sd_overall[i]
  }
# values_myocardial_infarction <- apply(myocardial_infarction[,b], 2, function(x) x/sd(x, na.rm = TRUE))

####################################################################################

# logistic regression adjusting for age (in 5-year groups), sex, region, education and fasting status
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_myocardial_infarction[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8), data = myocardial_infarction, family = "binomial"))
  names(fit)[i] <- colnames(values_myocardial_infarction)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(myocardial_infarction[which(!is.na(apply(data.frame(values_myocardial_infarction[,i], as.numeric(myocardial_infarction$age_cat5), myocardial_infarction$region_code, as.numeric(myocardial_infarction$is_female)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_MI_adj_age5_sex_region_smoking_education_fasting_14dec16.RData"
# load(filename)

# jpeg("lr_MI_adj_age5_sex_region_smoking_education_fasting_transformed_p_28jun16.jpeg", quality = 100)
# pdf("lr_MI_adj_age5_sex_region_smoking_education_fasting_transformed_p_28jun16.pdf")
plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
  #    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], adj = c(1, 1), cex = 0.7, col = "orchid4")
}

# jpeg("lr_MI_adj_age5_sex_region_smoking_education_fasting_transformed_p_text_28jun16.jpeg", quality = 100)
plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()
```

```{r, eval = FALSE}
## 15dec16

# forestplot

# setwd("../metabolomics")
# dir.create("forestplots dec16")

# load Jasper
source("J:/NDPH/from K drive/NDPHopen/Stats user area/Jasper/jasper/load.r")

# go through all files with results and convert them to the right format with biomarker categories
filenames <- dir(pattern = "lr_")[grep("14dec16.csv", dir(pattern = "lr_"))]
for (ii in 1:length(filenames)) {

	results <- read.csv(filenames[ii])
	results$n_cases_controls <- paste(results$n_cases, results$n_controls, sep = "/")
#	results$category <- gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", results$X)))))
#	results$category[2:dim(results)[1]] <- sapply(results$category[2:dim(results)[1]], function(x) paste("+", x))
#	results$category <- as.character(results$category)
#	results[,3:(dim(results)[2] - 2)] <- sapply(results[,3:(dim(results)[2] - 2)], as.numeric)
	results[,2:(dim(results)[2] - 1)] <- sapply(results[,2:(dim(results)[2] - 1)], as.numeric)
#	results$order <- seq(1:dim(results)[1])

#	results_split <- split(results, as.factor(results$category))
#	results_split <- lapply(results_split, function(x) rbind(c(rep(NA, dim(results)[2] - 1), x[1, dim(results)[2]]), x))
#	results <- do.call(rbind, results_split)
#	row.names(results) <- NULL
#	for (j in 1:dim(results)[1]) {
#		if (is.na(results[j, 2])) results[j, 2] <- results[j, 1]
#		}
#	results <- results[order(results$order),]

	# convert them to jasper format
	results$lci <- exp(results$estimate - (1.96 * results$se))
	results$uci <- exp(results$estimate + (1.96 * results$se))
#	results <- results[,c("category", "n_cases_controls", "OR", "lci", "uci", "deviance")]
#	results <- results[,c("n_cases_controls", "OR", "lci", "uci", "deviance")]
	results <- results[,c("X", "n_cases_controls", "OR", "lci", "uci")]
	names(results)[1] <- "Heading"
	names(results)[2] <- "N"
	names(results)[3] <- "HR1"
	names(results)[4:5] <- c("LCI1", "UCI1")
#	names(results)[6] <- "chisq"
#	results$ColHeadings <- c("Heading=Adjusted for", "N=N Cases/Controls", "chisq=expression(chi^2)", rep(NA, times = dim(results)[1] - 3))
#	results$ColHeadings <- c("Heading=Adjusted for", "N=N Cases/Controls", "chisq=expression(chi^2)", rep(NA, times = dim(results)[1] - 3))
	write.csv(results, "temporary_csv_file_for_forestplot_28sep15.csv", row.names = FALSE) ##
	rm(results)

	# create forestplot using Jasper
	ForestFromCSV("temporary_csv_file_for_forestplot_28sep15.csv", orient = "PORTRAIT", type = "PDF", StopIfCodeExists = FALSE, filestem = paste("forestplots dec16/forestplot", strsplit(filenames[ii], ".csv")[[1]][1], tolower(format(Sys.time(), "%d%b%y_%H%M")), sep = "_"), mainfont = 0.4, plot.width = 30, forest.Range = c(0.75, 2.0), forest.xticks = c(0.75, 1, 1.5, 2.0), mainTitle = paste("Odds ratios (95% CI) per standard deviation of metabolite for", gsub("_", " ", substr(filenames[ii], 4, regexpr("_adj", filenames[ii]) - 1)), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filenames[ii], regexpr("_adj_", filenames[ii]) + 5, regexpr("dec", filenames[ii]) - 4))))))), LogScale = TRUE, DataLogged = FALSE, ValueLabelsHeader = "OR (95% CI)", xlab = "Odds ratio (95% CI)", optimise.line.spacing = FALSE, optimise.fontsize = FALSE, auto.shrink.font = FALSE)

	}
```

<!--
23AUG16
-->

## Adjusted for SBP

Logistic regression of status on metabolite, adjusted for age (in 5-year groups), sex, region, smoking, education, fasting status and SBP

### Haemorrhagic stroke

```{r}
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_haemorrhagic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + sbp_mean, data = haemorrhagic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_haemorrhagic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(haemorrhagic_stroke[which(!is.na(apply(data.frame(values_haemorrhagic_stroke[,i], as.numeric(haemorrhagic_stroke$age_cat5), haemorrhagic_stroke$region_code, as.numeric(haemorrhagic_stroke$is_female), as.numeric(haemorrhagic_stroke$sbp_mean)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_sbp_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_sbp_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_HS_adj_age5_sex_region_smoking_education_fasting_sbp_14dec16.RData"
# load(filename)

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
    n <- length(p)
    o <- ordered_values(n)
    plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
	}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
```

### Ischaemic stroke

```{r}
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_ischaemic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + sbp_mean, data = ischaemic_stroke, family = "binomial"))
  names(fit)[i] <- colnames(values_ischaemic_stroke)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(ischaemic_stroke[which(!is.na(apply(data.frame(values_ischaemic_stroke[,i], as.numeric(ischaemic_stroke$age_cat5), ischaemic_stroke$region_code, as.numeric(ischaemic_stroke$is_female), as.numeric(ischaemic_stroke$sbp_mean)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_sbp_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_sbp_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_IS_adj_age5_sex_region_smoking_education_fasting_sbp_14dec16.RData"

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
```

### Myocardial infarction

```{r}
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_myocardial_infarction[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + sbp_mean, data = myocardial_infarction, family = "binomial"))
  names(fit)[i] <- colnames(values_myocardial_infarction)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(myocardial_infarction[which(!is.na(apply(data.frame(values_myocardial_infarction[,i], as.numeric(myocardial_infarction$age_cat5), myocardial_infarction$region_code, as.numeric(myocardial_infarction$is_female), as.numeric(myocardial_infarction$sbp_mean)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_sbp_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_sbp_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_MI_adj_age5_sex_region_smoking_education_fasting_sbp_14dec16.RData"

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
  #    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], adj = c(1, 1), cex = 0.7, col = "orchid4")
}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()
```

## Adjusted for BMI

Logistic regression of status on metabolite, adjusted for age (in 5-year groups), sex, region, smoking, education, fasting status and BMI

### Haemorrhagic stroke

```{r}
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_haemorrhagic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + bmi_calc, data = haemorrhagic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_haemorrhagic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(haemorrhagic_stroke[which(!is.na(apply(data.frame(values_haemorrhagic_stroke[,i], as.numeric(haemorrhagic_stroke$age_cat5), haemorrhagic_stroke$region_code, as.numeric(haemorrhagic_stroke$is_female), as.numeric(haemorrhagic_stroke$bmi_calc)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_bmi_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_bmi_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_HS_adj_age5_sex_region_smoking_education_fasting_bmi_14dec16.RData"
# load(filename)

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
    n <- length(p)
    o <- ordered_values(n)
    plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
	}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
```

### Ischaemic stroke

```{r}
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_ischaemic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + bmi_calc, data = ischaemic_stroke, family = "binomial"))
  names(fit)[i] <- colnames(values_ischaemic_stroke)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(ischaemic_stroke[which(!is.na(apply(data.frame(values_ischaemic_stroke[,i], as.numeric(ischaemic_stroke$age_cat5), ischaemic_stroke$region_code, as.numeric(ischaemic_stroke$is_female), as.numeric(ischaemic_stroke$bmi_calc)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_bmi_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_bmi_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_IS_adj_age5_sex_region_smoking_education_fasting_bmi_14dec16.RData"

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
```

### Myocardial infarction

```{r}
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_myocardial_infarction[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + bmi_calc, data = myocardial_infarction, family = "binomial"))
  names(fit)[i] <- colnames(values_myocardial_infarction)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(myocardial_infarction[which(!is.na(apply(data.frame(values_myocardial_infarction[,i], as.numeric(myocardial_infarction$age_cat5), myocardial_infarction$region_code, as.numeric(myocardial_infarction$is_female), as.numeric(myocardial_infarction$bmi_calc)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_bmi_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_bmi_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_MI_adj_age5_sex_region_smoking_education_fasting_bmi_14dec16.RData"

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
  #    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], adj = c(1, 1), cex = 0.7, col = "orchid4")
}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()
```

## Adjusted for SBP and BMI

Logistic regression of status on metabolite, adjusted for age (in 5-year groups), sex, region, smoking, education, fasting status, SBP and BMI

### Haemorrhagic stroke

```{r}
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_haemorrhagic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + sbp_mean + bmi_calc, data = haemorrhagic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_haemorrhagic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(haemorrhagic_stroke[which(!is.na(apply(data.frame(values_haemorrhagic_stroke[,i], as.numeric(haemorrhagic_stroke$age_cat5), haemorrhagic_stroke$region_code, as.numeric(haemorrhagic_stroke$is_female), as.numeric(haemorrhagic_stroke$bmi_calc)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_HS_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_14dec16.RData"
# load(filename)

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
    n <- length(p)
    o <- ordered_values(n)
    plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
	}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
```

### Ischaemic stroke

```{r}
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_ischaemic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + sbp_mean + bmi_calc, data = ischaemic_stroke, family = "binomial"))
  names(fit)[i] <- colnames(values_ischaemic_stroke)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(ischaemic_stroke[which(!is.na(apply(data.frame(values_ischaemic_stroke[,i], as.numeric(ischaemic_stroke$age_cat5), ischaemic_stroke$region_code, as.numeric(ischaemic_stroke$is_female), as.numeric(ischaemic_stroke$bmi_calc)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_IS_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_14dec16.RData"

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
```

### Myocardial infarction

```{r}
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_myocardial_infarction[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + sbp_mean + bmi_calc, data = myocardial_infarction, family = "binomial"))
  names(fit)[i] <- colnames(values_myocardial_infarction)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(myocardial_infarction[which(!is.na(apply(data.frame(values_myocardial_infarction[,i], as.numeric(myocardial_infarction$age_cat5), myocardial_infarction$region_code, as.numeric(myocardial_infarction$is_female), as.numeric(myocardial_infarction$bmi_calc)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_MI_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_14dec16.RData"

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
  #    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], adj = c(1, 1), cex = 0.7, col = "orchid4")
}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()
```

<!--
21DEC16
-->

## Logistic regression -- additionally adjusted for triglycerides

Logistic regression of status on metabolite, adjusted for age (in 5-year groups), sex, region, smoking, education and fasting status

```{r}
# overall sd for each metabolite
b <- 411:635
sd_overall <- apply(data[,b], 2, sd, na.rm = TRUE)
```

### Haemorrhagic stroke

```{r}
####################################################################################
# haemorrhagic stroke
####################################################################################

haemorrhagic_stroke <- data[which(data$status == "HS" | data$status == "control"),]
haemorrhagic_stroke$case <- NA
haemorrhagic_stroke$case[which(haemorrhagic_stroke$status == "control")] <- 0
haemorrhagic_stroke$case[which(haemorrhagic_stroke$status == "HS")] <- 1
table(haemorrhagic_stroke$case, useNA = "ifany")

####################################################################################

b <- 411:635
# names(data)[b]

# standardize values such that odds ratios are for each increase in one standard deviation
values_haemorrhagic_stroke <- haemorrhagic_stroke[,b]
for (i in 1:length(b)) {
  values_haemorrhagic_stroke[,i] <- values_haemorrhagic_stroke[,i] / sd_overall[i]
  }
# values_haemorrhagic_stroke <- apply(haemorrhagic_stroke[,b], 2, function(x) x/sd(x, na.rm = TRUE))

####################################################################################

# logistic regression adjusting for age (in 5-year groups), sex, region, education and fasting status
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_haemorrhagic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + Serum_total_triglycerides, data = haemorrhagic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_haemorrhagic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(haemorrhagic_stroke[which(!is.na(apply(data.frame(values_haemorrhagic_stroke[,i], as.numeric(haemorrhagic_stroke$age_cat5), haemorrhagic_stroke$region_code, as.numeric(haemorrhagic_stroke$is_female), as.numeric(haemorrhagic_stroke$Serum_total_triglycerides)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_triglycerides_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_triglycerides_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_HS_adj_age5_sex_region_smoking_education_fasting_triglycerides_14dec16.RData"
# load(filename)

# jpeg("lr_HS_adj_age5_sex_region_smoking_education_fasting_transformed_p_28jun16.jpeg", quality = 100)
# pdf("lr_HS_adj_age5_sex_region_smoking_education_fasting_transformed_p_28jun16.pdf")
plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
    n <- length(p)
    o <- ordered_values(n)
    plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
#    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], adj = c(1, 1), cex = 0.7, col = "orchid4")
	}

# jpeg("lr_HS_adj_age5_sex_region_smoking_education_fasting_transformed_p_text_28jun16.jpeg", quality = 100)
plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()
```

### Ischaemic stroke

```{r}
####################################################################################
# ischaemic stroke
####################################################################################

ischaemic_stroke <- data[which(data$status == "IS" | data$status == "control"),]
ischaemic_stroke$case <- NA
ischaemic_stroke$case[which(ischaemic_stroke$status == "control")] <- 0
ischaemic_stroke$case[which(ischaemic_stroke$status == "IS")] <- 1
table(ischaemic_stroke$case, useNA = "ifany")

####################################################################################

b <- 411:635
# names(data)[b]

# standardize values such that odds ratios are for each increase in one standard deviation
values_ischaemic_stroke <- ischaemic_stroke[,b]
for (i in 1:length(b)) {
  values_ischaemic_stroke[,i] <- values_ischaemic_stroke[,i] / sd_overall[i]
  }
# values_ischaemic_stroke <- apply(ischaemic_stroke[,b], 2, function(x) x/sd(x, na.rm = TRUE))

####################################################################################

# logistic regression adjusting for age (in 5-year groups), sex, region, education and fasting status
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_ischaemic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + Serum_total_triglycerides, data = ischaemic_stroke, family = "binomial"))
  names(fit)[i] <- colnames(values_ischaemic_stroke)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(ischaemic_stroke[which(!is.na(apply(data.frame(values_ischaemic_stroke[,i], as.numeric(ischaemic_stroke$age_cat5), ischaemic_stroke$region_code, as.numeric(ischaemic_stroke$is_female)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_triglycerides_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_triglycerides_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_IS_adj_age5_sex_region_smoking_education_fasting_triglycerides_14dec16.RData"
# load(filename)

# jpeg("lr_IS_adj_age5_sex_region_smoking_education_fasting_transformed_p_28jun16.jpeg", quality = 100)
# pdf("lr_IS_adj_age5_sex_region_smoking_education_fasting_transformed_p_28jun16.pdf")
plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
  #    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], adj = c(1, 1), cex = 0.7, col = "orchid4")
}

# jpeg("lr_IS_adj_age5_sex_region_smoking_education_fasting_transformed_p_text_20jun16.jpeg", quality = 100)
plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()
```

### Myocardial infarction

```{r}
####################################################################################
# myocardial infarction
####################################################################################

myocardial_infarction <- data[which(data$status == "MI" | data$status == "control"),]
myocardial_infarction$case <- NA
myocardial_infarction$case[which(myocardial_infarction$status == "control")] <- 0
myocardial_infarction$case[which(myocardial_infarction$status == "MI")] <- 1
table(myocardial_infarction$case, useNA = "ifany")

####################################################################################

b <- 411:635
# names(data)[b]

# standardize values such that odds ratios are for each increase in one standard deviation
values_myocardial_infarction <- myocardial_infarction[,b]
for (i in 1:length(b)) {
  values_myocardial_infarction[,i] <- values_myocardial_infarction[,i] / sd_overall[i]
  }
# values_myocardial_infarction <- apply(myocardial_infarction[,b], 2, function(x) x/sd(x, na.rm = TRUE))

####################################################################################

# logistic regression adjusting for age (in 5-year groups), sex, region, education and fasting status
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_myocardial_infarction[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + Serum_total_triglycerides, data = myocardial_infarction, family = "binomial"))
  names(fit)[i] <- colnames(values_myocardial_infarction)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(myocardial_infarction[which(!is.na(apply(data.frame(values_myocardial_infarction[,i], as.numeric(myocardial_infarction$age_cat5), myocardial_infarction$region_code, as.numeric(myocardial_infarction$is_female)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_triglycerides_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_triglycerides_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_MI_adj_age5_sex_region_smoking_education_fasting_triglycerides_14dec16.RData"
# load(filename)

# jpeg("lr_MI_adj_age5_sex_region_smoking_education_fasting_transformed_p_28jun16.jpeg", quality = 100)
# pdf("lr_MI_adj_age5_sex_region_smoking_education_fasting_transformed_p_28jun16.pdf")
plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
  #    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], adj = c(1, 1), cex = 0.7, col = "orchid4")
}

# jpeg("lr_MI_adj_age5_sex_region_smoking_education_fasting_transformed_p_text_28jun16.jpeg", quality = 100)
plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()
```

```{r, eval = FALSE}
## 15dec16

# forestplot

# setwd("../metabolomics")
# dir.create("forestplots dec16")

# load Jasper
source("J:/NDPH/from K drive/NDPHopen/Stats user area/Jasper/jasper/load.r")

# go through all files with results and convert them to the right format with biomarker categories
filenames <- dir(pattern = "lr_")[grep("triglycerides_14dec16.csv", dir(pattern = "lr_"))]
for (ii in 1:length(filenames)) {

	results <- read.csv(filenames[ii])
	results$n_cases_controls <- paste(results$n_cases, results$n_controls, sep = "/")
#	results$category <- gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", results$X)))))
#	results$category[2:dim(results)[1]] <- sapply(results$category[2:dim(results)[1]], function(x) paste("+", x))
#	results$category <- as.character(results$category)
#	results[,3:(dim(results)[2] - 2)] <- sapply(results[,3:(dim(results)[2] - 2)], as.numeric)
	results[,2:(dim(results)[2] - 1)] <- sapply(results[,2:(dim(results)[2] - 1)], as.numeric)
#	results$order <- seq(1:dim(results)[1])

#	results_split <- split(results, as.factor(results$category))
#	results_split <- lapply(results_split, function(x) rbind(c(rep(NA, dim(results)[2] - 1), x[1, dim(results)[2]]), x))
#	results <- do.call(rbind, results_split)
#	row.names(results) <- NULL
#	for (j in 1:dim(results)[1]) {
#		if (is.na(results[j, 2])) results[j, 2] <- results[j, 1]
#		}
#	results <- results[order(results$order),]

	# convert them to jasper format
	results$lci <- exp(results$estimate - (1.96 * results$se))
	results$uci <- exp(results$estimate + (1.96 * results$se))
#	results <- results[,c("category", "n_cases_controls", "OR", "lci", "uci", "deviance")]
#	results <- results[,c("n_cases_controls", "OR", "lci", "uci", "deviance")]
	results <- results[,c("X", "n_cases_controls", "OR", "lci", "uci")]
	names(results)[1] <- "Heading"
	names(results)[2] <- "N"
	names(results)[3] <- "HR1"
	names(results)[4:5] <- c("LCI1", "UCI1")
#	names(results)[6] <- "chisq"
#	results$ColHeadings <- c("Heading=Adjusted for", "N=N Cases/Controls", "chisq=expression(chi^2)", rep(NA, times = dim(results)[1] - 3))
#	results$ColHeadings <- c("Heading=Adjusted for", "N=N Cases/Controls", "chisq=expression(chi^2)", rep(NA, times = dim(results)[1] - 3))
	write.csv(results, "temporary_csv_file_for_forestplot_28sep15.csv", row.names = FALSE) ##
	rm(results)

	# create forestplot using Jasper
	ForestFromCSV("temporary_csv_file_for_forestplot_28sep15.csv", orient = "PORTRAIT", type = "PDF", StopIfCodeExists = FALSE, filestem = paste("forestplots dec16/forestplot", strsplit(filenames[ii], ".csv")[[1]][1], tolower(format(Sys.time(), "%d%b%y_%H%M")), sep = "_"), mainfont = 0.4, plot.width = 30, forest.Range = c(0.75, 2.0), forest.xticks = c(0.75, 1, 1.5, 2.0), mainTitle = paste("Odds ratios (95% CI) per standard deviation of metabolite for", gsub("_", " ", substr(filenames[ii], 4, regexpr("_adj", filenames[ii]) - 1)), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filenames[ii], regexpr("_adj_", filenames[ii]) + 5, regexpr("dec", filenames[ii]) - 4))))))), LogScale = TRUE, DataLogged = FALSE, ValueLabelsHeader = "OR (95% CI)", xlab = "Odds ratio (95% CI)", optimise.line.spacing = FALSE, optimise.fontsize = FALSE, auto.shrink.font = FALSE)

	}
```

## Adjusted for SBP

Logistic regression of status on metabolite, adjusted for age (in 5-year groups), sex, region, smoking, education, fasting status and SBP

### Haemorrhagic stroke

```{r}
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_haemorrhagic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + sbp_mean + Serum_total_triglycerides, data = haemorrhagic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_haemorrhagic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(haemorrhagic_stroke[which(!is.na(apply(data.frame(values_haemorrhagic_stroke[,i], as.numeric(haemorrhagic_stroke$age_cat5), haemorrhagic_stroke$region_code, as.numeric(haemorrhagic_stroke$is_female), as.numeric(haemorrhagic_stroke$sbp_mean)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_sbp_triglycerides_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_sbp_triglycerides_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_HS_adj_age5_sex_region_smoking_education_fasting_sbp_triglycerides_14dec16.RData"
# load(filename)

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
    n <- length(p)
    o <- ordered_values(n)
    plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
	}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
```

### Ischaemic stroke

```{r}
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_ischaemic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + sbp_mean + Serum_total_triglycerides, data = ischaemic_stroke, family = "binomial"))
  names(fit)[i] <- colnames(values_ischaemic_stroke)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(ischaemic_stroke[which(!is.na(apply(data.frame(values_ischaemic_stroke[,i], as.numeric(ischaemic_stroke$age_cat5), ischaemic_stroke$region_code, as.numeric(ischaemic_stroke$is_female), as.numeric(ischaemic_stroke$sbp_mean)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_sbp_triglycerides_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_sbp_triglycerides_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_IS_adj_age5_sex_region_smoking_education_fasting_sbp_triglycerides_14dec16.RData"

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
```

### Myocardial infarction

```{r}
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_myocardial_infarction[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + sbp_mean + Serum_total_triglycerides, data = myocardial_infarction, family = "binomial"))
  names(fit)[i] <- colnames(values_myocardial_infarction)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(myocardial_infarction[which(!is.na(apply(data.frame(values_myocardial_infarction[,i], as.numeric(myocardial_infarction$age_cat5), myocardial_infarction$region_code, as.numeric(myocardial_infarction$is_female), as.numeric(myocardial_infarction$sbp_mean)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_sbp_triglycerides_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_sbp_triglycerides_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_MI_adj_age5_sex_region_smoking_education_fasting_sbp_triglycerides_14dec16.RData"

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
  #    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], adj = c(1, 1), cex = 0.7, col = "orchid4")
}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()
```

## Adjusted for BMI

Logistic regression of status on metabolite, adjusted for age (in 5-year groups), sex, region, smoking, education, fasting status and BMI

### Haemorrhagic stroke

```{r}
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_haemorrhagic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + bmi_calc + Serum_total_triglycerides, data = haemorrhagic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_haemorrhagic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(haemorrhagic_stroke[which(!is.na(apply(data.frame(values_haemorrhagic_stroke[,i], as.numeric(haemorrhagic_stroke$age_cat5), haemorrhagic_stroke$region_code, as.numeric(haemorrhagic_stroke$is_female), as.numeric(haemorrhagic_stroke$bmi_calc)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_bmi_triglycerides_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_bmi_triglycerides_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_HS_adj_age5_sex_region_smoking_education_fasting_bmi_triglycerides_14dec16.RData"
# load(filename)

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
    n <- length(p)
    o <- ordered_values(n)
    plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
	}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
```

### Ischaemic stroke

```{r}
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_ischaemic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + bmi_calc + Serum_total_triglycerides, data = ischaemic_stroke, family = "binomial"))
  names(fit)[i] <- colnames(values_ischaemic_stroke)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(ischaemic_stroke[which(!is.na(apply(data.frame(values_ischaemic_stroke[,i], as.numeric(ischaemic_stroke$age_cat5), ischaemic_stroke$region_code, as.numeric(ischaemic_stroke$is_female), as.numeric(ischaemic_stroke$bmi_calc)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_bmi_triglycerides_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_bmi_triglycerides_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_IS_adj_age5_sex_region_smoking_education_fasting_bmi_triglycerides_14dec16.RData"

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
```

### Myocardial infarction

```{r}
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_myocardial_infarction[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + bmi_calc + Serum_total_triglycerides, data = myocardial_infarction, family = "binomial"))
  names(fit)[i] <- colnames(values_myocardial_infarction)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(myocardial_infarction[which(!is.na(apply(data.frame(values_myocardial_infarction[,i], as.numeric(myocardial_infarction$age_cat5), myocardial_infarction$region_code, as.numeric(myocardial_infarction$is_female), as.numeric(myocardial_infarction$bmi_calc)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_bmi_triglycerides_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_bmi_triglycerides_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_MI_adj_age5_sex_region_smoking_education_fasting_bmi_triglycerides_14dec16.RData"

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
  #    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], adj = c(1, 1), cex = 0.7, col = "orchid4")
}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()
```

## Adjusted for SBP and BMI

Logistic regression of status on metabolite, adjusted for age (in 5-year groups), sex, region, smoking, education, fasting status, SBP and BMI

### Haemorrhagic stroke

```{r}
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_haemorrhagic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + sbp_mean + bmi_calc + Serum_total_triglycerides, data = haemorrhagic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_haemorrhagic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(haemorrhagic_stroke[which(!is.na(apply(data.frame(values_haemorrhagic_stroke[,i], as.numeric(haemorrhagic_stroke$age_cat5), haemorrhagic_stroke$region_code, as.numeric(haemorrhagic_stroke$is_female), as.numeric(haemorrhagic_stroke$bmi_calc)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_triglycerides_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_HS_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_triglycerides_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_HS_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_triglycerides_14dec16.RData"
# load(filename)

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
    n <- length(p)
    o <- ordered_values(n)
    plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
	}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
```

### Ischaemic stroke

```{r}
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_ischaemic_stroke[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + sbp_mean + bmi_calc + Serum_total_triglycerides, data = ischaemic_stroke, family = "binomial"))
  names(fit)[i] <- colnames(values_ischaemic_stroke)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(ischaemic_stroke[which(!is.na(apply(data.frame(values_ischaemic_stroke[,i], as.numeric(ischaemic_stroke$age_cat5), ischaemic_stroke$region_code, as.numeric(ischaemic_stroke$is_female), as.numeric(ischaemic_stroke$bmi_calc)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_triglycerides_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_IS_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_triglycerides_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_IS_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_triglycerides_14dec16.RData"

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
```

### Myocardial infarction

```{r}
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(glm(case ~ values_myocardial_infarction[,i] + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + sbp_mean + bmi_calc + Serum_total_triglycerides, data = myocardial_infarction, family = "binomial"))
  names(fit)[i] <- colnames(values_myocardial_infarction)[i]
}

numbers <- list()
for (i in 1:length(b)) {
  numbers[[i]] <- table(myocardial_infarction[which(!is.na(apply(data.frame(values_myocardial_infarction[,i], as.numeric(myocardial_infarction$age_cat5), myocardial_infarction$region_code, as.numeric(myocardial_infarction$is_female), as.numeric(myocardial_infarction$bmi_calc)), 1, sum))),]$case)
}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])

load("../metabolomics/metabolomics_labels_9sep15.RData")
row.names(fit_df) <- sapply(row.names(fit_df), function(x) paste(gsub("_", " ", x), " (", metabolomics_labels[2, x], ")", sep = ""))
# save(fit_df, file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_triglycerides_14dec16.RData")

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))

# write.csv(format(fit_df, digits = 3)[order(fit_df$p),], file = "lr_MI_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_triglycerides_14dec16.csv")

library(ManyTests)
library(Hmisc)

filename <- "lr_MI_adj_age5_sex_region_smoking_education_fasting_sbp_bmi_triglycerides_14dec16.RData"

plot_pvalues(fit_df$p)
abline(0, 1, lty = 2, col = "darkmagenta")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)

# adj: one or two values in [0, 1] which specify the x (and optionally y) adjustment of the labels. On most devices values outside that interval will also work.
# pos: a position specifier for the text. If specified this overrides any adj value given. Values of 1, 2, 3 and 4, respectively indicate positions below, to the left of, above and to the right of the specified coordinates.
# offset: when pos is specified, this value gives the offset of the label from the specified coordinate in fractions of a character width.

plot_pvalues_text <- function (p, text, n_text) {
  n <- length(p)
  o <- ordered_values(n)
  plot(o, -log(p[order(p, decreasing = TRUE)]), xlab = "Expected values", ylab = "-log(p)")
  text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], pos = 2, cex = 0.7, col = "orchid4")
  #    text(o[(n - n_text + 1):n], -log(p[order(p, decreasing = TRUE)][(n - n_text + 1):n]), labels = text[order(p, decreasing = TRUE)][(n - n_text + 1):n], adj = c(1, 1), cex = 0.7, col = "orchid4")
}

plot_pvalues_text(fit_df$p, row.names(fit_df), n_text = 9)
abline(0, 1, lty = 2, col = "green4")
mtext(paste(capitalize(gsub("_", " ", substr(filename, 4, regexpr("_adj", filename) - 1))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filename, regexpr("_adj_", filename) + 5, regexpr("jun", filename) - 4))))))), side = 3, line = 1)
# dev.off()
```

<!--
5OCT16
-->

## Correlation of NMR with LIMS

```{r}
## NMR and LIMS

# 1 mmol = 1000 umol
# 1 milligram/decilitre = 0.01 gram/litre

# there are 8 markers in both metabolomics and biochemistry plus glucose

common <- list()
common[[1]] <- c("chol_result_x10000", "Serum_total_cholesterol")
common[[2]] <- c("tg_result_x10000", "Serum_total_triglycerides")
common[[3]] <- c("ldl_result_x10000", "Total_cholesterol_in_LDL")
common[[4]] <- c("hdl_result_x10000", "Total_cholesterol_in_HDL")
common[[5]] <- c("apoa1_result_x10000", "Apolipoprotein_A_I")
common[[6]] <- c("apob_result_x10000", "Apolipoprotein_B")
common[[7]] <- c("crea_result_x10000", "Creatinine")
common[[8]] <- c("alb_result_x10000", "Albumin")
# common[[9]] <- c("test_random_glucose_x10", "Glucose")

# data on markers in common
common_data <- list()
for (i in 1:length(common)) {
	common_data[[i]] <- list(data[,common[[i]][1]], data[,common[[i]][2]])
	names(common_data)[i] <- gsub("_", " ", common[[i]][2])
	names(common_data[[i]]) <- common[[i]]
	}

length(common_data) # 8

# str(common_data)

names(common_data)
# [1] "Serum total cholesterol"   "Serum total triglycerides" "Total cholesterol in LDL"  "Total cholesterol in HDL" 
# [5] "Apolipoprotein A I"        "Apolipoprotein B"          "Creatinine"                "Albumin"                  
# [9] "Glucose" 

# convert all metabolomics measurements to the biochemistry units

# LDL cholesterol is in mmol/L in both
# HDL cholesterol is in mmol/L in both
# triglycerides is in mmol/L in both
# total cholesterol is in mmol/L in both
# glucose need to divide baseline by 10 and it will become mmol/L
# creatinine - convert metabolomics creatinine from mmol/L to umol/L (multiply by 1000)
# apolipoporotein B - convert metabolomics from g/L to mg/dL (multiply by 100)
# apolipoporotein A1 - convert metabolomics from g/L to mg/dL (multiply by 100)
# albumin - g/L in biochemistry and signal area in albumin

# ApoA1
common_data[[5]][[2]] <- common_data[[5]][[2]] * 100
# ApoB
common_data[[6]][[2]] <- common_data[[6]][[2]] * 100
# creatinine
common_data[[7]][[2]] <- common_data[[7]][[2]] * 1000
# glucose
# common_data[[9]][[1]] <- common_data[[9]][[1]] / 10

# labels for plots with the correct (changed) units

# load("../blood biochemistry/labels_dataframe_13july15.RData")
load("labels_dataframe_13july15.RData")
row.names(labels_dataframe) <- labels_dataframe$variable2

for (i in 1:length(common_data)) {
	common_data[[i]]$label <- list()
	common_data[[i]]$label[[1]] <- common_data[[i]]$label[[2]] <- labels_dataframe[names(common_data[[i]])[1],]$name
	}
# albumin still different
common_data[[8]]$label[[2]] <- paste(gsub("_", " ", names(common_data[[8]])[2]), " (", metabolomics_labels[2, names(common_data[[8]])[2]], ")", sep = "")
# add label for glucose
# common_data[[9]]$label[[1]] <- common_data[[9]]$label[[2]] <- paste(gsub("_", " ", names(common_data[[9]])[2]), " (", metabolomics_labels[2, names(common_data[[9]])[2]], ")", sep = "")

# save(common_data, file = "common_data_5oct16.RData")

## correlation of NMR and LIMS

cor_nmr_lims <- data.frame("Correlation" = unlist(lapply(common_data, function(x) cor(x[[1]], x[[2]], use = "complete.obs"))))
# write.csv(cor_nmr_lims, file = "cor_nmr_lims_5oct16.csv")

# kable(cor_nmr_lims, digits = 2)

## correlation of NMR and LIMS

cor_nmr_lims <- data.frame("Correlation" = unlist(lapply(common_data, function(x) cor(x[[1]], x[[2]], use = "complete.obs"))), "Mean NMR" = unlist(lapply(common_data, function(x) mean(x[[2]][which(!is.na(x[[1]]) & !is.na(x[[2]]))]))), "Standard deviation NMR" = unlist(lapply(common_data, function(x) sd(x[[2]][which(!is.na(x[[1]]) & !is.na(x[[2]]))]))), "Mean LIMS" = unlist(lapply(common_data, function(x) mean(x[[1]][which(!is.na(x[[1]]) & !is.na(x[[2]]))]))), "Standard deviation LIMS" = unlist(lapply(common_data, function(x) sd(x[[1]][which(!is.na(x[[1]]) & !is.na(x[[2]]))]))), "N" = unlist(lapply(common_data, function(x) length(x[[2]][which(!is.na(x[[1]]) & !is.na(x[[2]]))]))))
# write.csv(round(cor_nmr_lims, 2), file = "cor_nmr_lims_14dec16.csv")

kable(cor_nmr_lims, digits = 2)

cor_nmr_lims <- data.frame("Correlation" = unlist(lapply(common_data, function(x) cor(x[[1]], x[[2]], use = "complete.obs"))), "Spearman Correlation" = unlist(lapply(common_data, function(x) cor(x[[1]], x[[2]], method = "spearman", use = "complete.obs"))), "Mean NMR" = unlist(lapply(common_data, function(x) mean(x[[2]][which(!is.na(x[[1]]) & !is.na(x[[2]]))]))), "Standard deviation NMR" = unlist(lapply(common_data, function(x) sd(x[[2]][which(!is.na(x[[1]]) & !is.na(x[[2]]))]))), "Mean LIMS" = unlist(lapply(common_data, function(x) mean(x[[1]][which(!is.na(x[[1]]) & !is.na(x[[2]]))]))), "Standard deviation LIMS" = unlist(lapply(common_data, function(x) sd(x[[1]][which(!is.na(x[[1]]) & !is.na(x[[2]]))]))), "N" = unlist(lapply(common_data, function(x) length(x[[2]][which(!is.na(x[[1]]) & !is.na(x[[2]]))]))))
# cor_nmr_lims
# Serum total triglycerides   0.7656548            0.9255032
lapply(common_data, function(x) cor(log(x[[1]]), log(x[[2]]), use = "complete.obs"))
```

## Associations in NMR and LIMS

```{r}
## associations in NMR and LIMS

####################################################################################
# haemorrhagic stroke
####################################################################################

haemorrhagic_stroke <- data[which(data$status == "HS" | data$status == "control"),]
haemorrhagic_stroke$case <- NA
haemorrhagic_stroke$case[which(haemorrhagic_stroke$status == "control")] <- 0
haemorrhagic_stroke$case[which(haemorrhagic_stroke$status == "HS")] <- 1
table(haemorrhagic_stroke$case, useNA = "ifany")

####################################################################################
# metabolomics
####################################################################################

# standardize values such that odds ratios are for each increase in one standard deviation
values_haemorrhagic_stroke <- do.call(cbind, lapply(common_data, function(x) {x <- x[[2]][which(data$status == "HS" | data$status == "control")]; x/sd(x, na.rm = TRUE)}))

b <- 1:(dim(values_haemorrhagic_stroke)[2])

####################################################################################

# logistic regression adjusting for age (in 5-year groups), region, sex, smoking_category, education
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_haemorrhagic_stroke[,i] + age_cat5 + as.factor(region_code) + is_female + as.factor(smoking_category) + education_combined, data = haemorrhagic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_haemorrhagic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(haemorrhagic_stroke[which(!is.na(apply(data.frame(values_haemorrhagic_stroke[,i], haemorrhagic_stroke$region_code, as.numeric(haemorrhagic_stroke$is_female), as.numeric(haemorrhagic_stroke$smoking_category)), 1, sum))),]$status)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])
row.names(fit_df) <- lapply(common_data, function(x) as.character(x[[3]][[2]][1]))

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))
# save(fit_df, file = "lr_HS_metab_common_adj_age5_region_sex_smoking_education_5oct16.RData")
# write.csv(format(fit_df, digits = 2), file = "lr_HS_metab_common_adj_age5_region_sex_smoking_education_5oct16.csv")

kable(data.frame("HS" = "metabolomics"))
kable(fit_df, digits = 2)

####################################################################################
# biochemistry
####################################################################################

# standardize values such that odds ratios are for each increase in one standard deviation
values_haemorrhagic_stroke <- do.call(cbind, lapply(common_data, function(x) {x <- x[[1]][which(data$status == "HS" | data$status == "control")]; x/sd(x, na.rm = TRUE)}))

b <- 1:(dim(values_haemorrhagic_stroke)[2])

####################################################################################

# logistic regression adjusting for age (in 5-year groups), region, sex, smoking_category, education
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_haemorrhagic_stroke[,i] + age_cat5 + as.factor(region_code) + is_female + as.factor(smoking_category) + education_combined, data = haemorrhagic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_haemorrhagic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(haemorrhagic_stroke[which(!is.na(apply(data.frame(values_haemorrhagic_stroke[,i], as.numeric(haemorrhagic_stroke$smoking_category)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])
row.names(fit_df) <- lapply(common_data, function(x) as.character(x[[3]][[1]][1]))

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))
# save(fit_df, file = "lr_HS_biochem_common_adj_age5_region_sex_smoking_education_5oct16.RData")
# write.csv(format(fit_df, digits = 2), file = "lr_HS_biochem_common_adj_age5_region_sex_smoking_education_5oct16.csv")

kable(data.frame("HS" = "biochemistry"))
kable(fit_df, digits = 2)

####################################################################################
# ischaemic stroke
####################################################################################

ischaemic_stroke <- data[which(data$status == "IS" | data$status == "control"),]
ischaemic_stroke$case <- NA
ischaemic_stroke$case[which(ischaemic_stroke$status == "control")] <- 0
ischaemic_stroke$case[which(ischaemic_stroke$status == "IS")] <- 1
table(ischaemic_stroke$case, useNA = "ifany")

####################################################################################
# metabolomics
####################################################################################

# standardize values such that odds ratios are for each increase in one standard deviation
values_ischaemic_stroke <- do.call(cbind, lapply(common_data, function(x) {x <- x[[2]][which(data$status == "IS" | data$status == "control")]; x/sd(x, na.rm = TRUE)}))

b <- 1:(dim(values_ischaemic_stroke)[2])

####################################################################################

# logistic regression adjusting for age (in 5-year groups), region, sex, smoking_category, education
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_ischaemic_stroke[,i] + age_cat5 + as.factor(region_code) + is_female + as.factor(smoking_category) + education_combined, data = ischaemic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_ischaemic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(ischaemic_stroke[which(!is.na(apply(data.frame(values_ischaemic_stroke[,i], as.numeric(ischaemic_stroke$age_cat5), ischaemic_stroke$region_code, as.numeric(ischaemic_stroke$is_female), as.numeric(ischaemic_stroke$smoking_category)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])
row.names(fit_df) <- lapply(common_data, function(x) as.character(x[[3]][[2]][1]))

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))
# save(fit_df, file = "lr_IS_metab_common_adj_age5_region_sex_smoking_education_5oct16.RData")
# write.csv(format(fit_df, digits = 2), file = "lr_IS_metab_common_adj_age5_region_sex_smoking_education_5oct16.csv")

kable(data.frame("IS" = "metabolomics"))
kable(fit_df, digits = 2)

####################################################################################
# biochemistry
####################################################################################

# standardize values such that odds ratios are for each increase in one standard deviation
values_ischaemic_stroke <- do.call(cbind, lapply(common_data, function(x) {x <- x[[1]][which(data$status == "IS" | data$status == "control")]; x/sd(x, na.rm = TRUE)}))

b <- 1:(dim(values_ischaemic_stroke)[2])

####################################################################################

# logistic regression adjusting for age (in 5-year groups), region, sex, smoking_category, education
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_ischaemic_stroke[,i] + age_cat5 + as.factor(region_code) + is_female + as.factor(smoking_category) + education_combined, data = ischaemic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_ischaemic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(ischaemic_stroke[which(!is.na(apply(data.frame(values_ischaemic_stroke[,i], as.numeric(ischaemic_stroke$age_cat5), ischaemic_stroke$region_code, as.numeric(ischaemic_stroke$is_female), as.numeric(ischaemic_stroke$smoking_category)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])
row.names(fit_df) <- lapply(common_data, function(x) as.character(x[[3]][[1]][1]))

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))
# save(fit_df, file = "lr_IS_biochem_common_adj_age5_region_sex_smoking_education_5oct16.RData")
# write.csv(format(fit_df, digits = 2), file = "lr_IS_biochem_common_adj_age5_region_sex_smoking_education_5oct16.csv")

kable(data.frame("IS" = "biochemistry"))
kable(fit_df, digits = 2)

####################################################################################
# myocardial infarction
####################################################################################

myocardial_infarction <- data[which(data$status == "MI" | data$status == "control"),]
myocardial_infarction$case <- NA
myocardial_infarction$case[which(myocardial_infarction$status == "control")] <- 0
myocardial_infarction$case[which(myocardial_infarction$status == "MI")] <- 1
table(myocardial_infarction$case, useNA = "ifany")

####################################################################################
# metabolomics
####################################################################################

# standardize values such that odds ratios are for each increase in one standard deviation
values_myocardial_infarction <- do.call(cbind, lapply(common_data, function(x) {x <- x[[2]][which(data$status == "MI" | data$status == "control")]; x/sd(x, na.rm = TRUE)}))

b <- 1:(dim(values_myocardial_infarction)[2])

####################################################################################

# logistic regression adjusting for age (in 5-year groups), region, sex, smoking_category, education
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_myocardial_infarction[,i] + age_cat5 + as.factor(region_code) + is_female + as.factor(smoking_category) + education_combined, data = myocardial_infarction, family = "binomial"))
	names(fit)[i] <- colnames(values_myocardial_infarction)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(myocardial_infarction[which(!is.na(apply(data.frame(values_myocardial_infarction[,i], as.numeric(myocardial_infarction$age_cat5), myocardial_infarction$region_code, as.numeric(myocardial_infarction$is_female), as.numeric(myocardial_infarction$smoking_category)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])
row.names(fit_df) <- lapply(common_data, function(x) as.character(x[[3]][[2]][1]))

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))
# save(fit_df, file = "lr_MI_metab_common_adj_age5_region_sex_smoking_education_5oct16.RData")
# write.csv(format(fit_df, digits = 2), file = "lr_MI_metab_common_adj_age5_region_sex_smoking_education_5oct16.csv")

kable(data.frame("MI" = "metabolomics"))
kable(fit_df, digits = 2)

####################################################################################
# biochemistry
####################################################################################

# standardize values such that odds ratios are for each increase in one standard deviation
values_myocardial_infarction <- do.call(cbind, lapply(common_data, function(x) {x <- x[[1]][which(data$status == "MI" | data$status == "control")]; x/sd(x, na.rm = TRUE)}))

b <- 1:(dim(values_myocardial_infarction)[2])

####################################################################################

# logistic regression adjusting for age (in 5-year groups), region, sex, smoking_category, education
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_myocardial_infarction[,i] + age_cat5 + as.factor(region_code) + is_female + as.factor(smoking_category) + education_combined, data = myocardial_infarction, family = "binomial"))
	names(fit)[i] <- colnames(values_myocardial_infarction)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(myocardial_infarction[which(!is.na(apply(data.frame(values_myocardial_infarction[,i], myocardial_infarction$region_code, as.numeric(myocardial_infarction$is_female), as.numeric(myocardial_infarction$smoking_category)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])
row.names(fit_df) <- lapply(common_data, function(x) as.character(x[[3]][[1]][1]))

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))
# save(fit_df, file = "lr_MI_biochem_common_adj_age5_region_sex_smoking_education_5oct16.RData")
# write.csv(format(fit_df, digits = 2), file = "lr_MI_biochem_common_adj_age5_region_sex_smoking_education_5oct16.csv")

kable(data.frame("MI" = "biochemistry"))
kable(fit_df, digits = 2)
```

```{r, eval = FALSE}
####################################################################################
# forestplots
####################################################################################

# load Jasper
source("J:/NDPH/from K drive/NDPHopen/Stats user area/Jasper/jasper/load_v2.r")

# go through all files with results and convert them to the right format with biomarker categories
filenames <- dir(pattern = "5oct16.csv")[2:7]

for (ii in 1:length(filenames)) {

	results <- read.csv(filenames[ii])
	results$n_cases_controls <- paste(results$n_cases, results$n_controls, sep = "/")
	results[,2:(dim(results)[2] - 1)] <- sapply(results[,2:(dim(results)[2] - 1)], as.numeric)

	# convert them to jasper format
	results$lci <- exp(results$estimate - (1.96 * results$se))
	results$uci <- exp(results$estimate + (1.96 * results$se))
	results <- results[,c("X", "n_cases_controls", "OR", "lci", "uci")]
	names(results)[1] <- "Heading"
	names(results)[2] <- "N"
	names(results)[3] <- "HR1"
	names(results)[4:5] <- c("LCI1", "UCI1")
	write.csv(results, "temporary_csv_file_for_forestplot_28sep15.csv", row.names = FALSE) ##
	rm(results)

	# create forestplot using Jasper
	ForestFromCSV("temporary_csv_file_for_forestplot_28sep15.csv", orient = "PORTRAIT", type = "PDF", StopIfCodeExists = FALSE, filestem = paste("forestplot", strsplit(filenames[ii], ".csv")[[1]][1], tolower(format(Sys.time(), "%d%b%y_%H%M")), sep = "_"), mainfont = 1, plot.width = 30, forest.Range = c(0.5, 2.5), forest.xticks = c(0.5, 1, 1.5, 2.0, 2.5), mainTitle = paste("Odds ratios (95% CI) per standard deviation for", gsub("biochem", "- biochemistry", gsub("metab", "- metabolomics", gsub("common", "", gsub("_", " ", substr(filenames[ii], 4, regexpr("_adj", filenames[ii]) - 1))))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filenames[ii], regexpr("_adj_", filenames[ii]) + 5, regexpr("oct", filenames[ii]) - 3))))))), LogScale = TRUE, DataLogged = FALSE, ValueLabelsHeader = "OR (95% CI)", xlab = "Odds ratio (95% CI)")

	}

# , optimise.line.spacing = FALSE, optimise.fontsize = FALSE, auto.shrink.font = FALSE

####################################################################################
```

## Associations in NMR and LIMS

Adjusting for age (in 5-year groups), region, sex, smoking, education and fasting status

```{r}
## associations in NMR and LIMS

####################################################################################
# haemorrhagic stroke
####################################################################################

haemorrhagic_stroke <- data[which(data$status == "HS" | data$status == "control"),]
haemorrhagic_stroke$case <- NA
haemorrhagic_stroke$case[which(haemorrhagic_stroke$status == "control")] <- 0
haemorrhagic_stroke$case[which(haemorrhagic_stroke$status == "HS")] <- 1
table(haemorrhagic_stroke$case, useNA = "ifany")

####################################################################################
# metabolomics
####################################################################################

# standardize values such that odds ratios are for each increase in one standard deviation
values_haemorrhagic_stroke <- do.call(cbind, lapply(common_data, function(x) {x <- x[[2]][which(data$status == "HS" | data$status == "control")]; x/sd(x, na.rm = TRUE)}))

b <- 1:(dim(values_haemorrhagic_stroke)[2])

####################################################################################

# logistic regression adjusting for age (in 5-year groups), region, sex, smoking_category, education
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_haemorrhagic_stroke[,i] + age_cat5 + as.factor(region_code) + is_female + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8), data = haemorrhagic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_haemorrhagic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(haemorrhagic_stroke[which(!is.na(apply(data.frame(values_haemorrhagic_stroke[,i], haemorrhagic_stroke$region_code, as.numeric(haemorrhagic_stroke$is_female), as.numeric(haemorrhagic_stroke$smoking_category)), 1, sum))),]$status)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])
row.names(fit_df) <- lapply(common_data, function(x) as.character(x[[3]][[2]][1]))

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))
# save(fit_df, file = "lr_HS_metab_common_adj_age5_region_sex_smoking_education_fasting_25oct16.RData")
# write.csv(format(fit_df, digits = 2), file = "lr_HS_metab_common_adj_age5_region_sex_smoking_education_fasting_25oct16.csv")

kable(data.frame("HS" = "metabolomics"))
kable(fit_df, digits = 2)

####################################################################################
# biochemistry
####################################################################################

# standardize values such that odds ratios are for each increase in one standard deviation
values_haemorrhagic_stroke <- do.call(cbind, lapply(common_data, function(x) {x <- x[[1]][which(data$status == "HS" | data$status == "control")]; x/sd(x, na.rm = TRUE)}))

b <- 1:(dim(values_haemorrhagic_stroke)[2])

####################################################################################

# logistic regression adjusting for age (in 5-year groups), region, sex, smoking_category, education
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_haemorrhagic_stroke[,i] + age_cat5 + as.factor(region_code) + is_female + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8), data = haemorrhagic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_haemorrhagic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(haemorrhagic_stroke[which(!is.na(apply(data.frame(values_haemorrhagic_stroke[,i], as.numeric(haemorrhagic_stroke$smoking_category)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])
row.names(fit_df) <- lapply(common_data, function(x) as.character(x[[3]][[1]][1]))

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))
# save(fit_df, file = "lr_HS_biochem_common_adj_age5_region_sex_smoking_education_fasting_25oct16.RData")
# write.csv(format(fit_df, digits = 2), file = "lr_HS_biochem_common_adj_age5_region_sex_smoking_education_fasting_25oct16.csv")

kable(data.frame("HS" = "biochemistry"))
kable(fit_df, digits = 2)

####################################################################################
# ischaemic stroke
####################################################################################

ischaemic_stroke <- data[which(data$status == "IS" | data$status == "control"),]
ischaemic_stroke$case <- NA
ischaemic_stroke$case[which(ischaemic_stroke$status == "control")] <- 0
ischaemic_stroke$case[which(ischaemic_stroke$status == "IS")] <- 1
table(ischaemic_stroke$case, useNA = "ifany")

####################################################################################
# metabolomics
####################################################################################

# standardize values such that odds ratios are for each increase in one standard deviation
values_ischaemic_stroke <- do.call(cbind, lapply(common_data, function(x) {x <- x[[2]][which(data$status == "IS" | data$status == "control")]; x/sd(x, na.rm = TRUE)}))

b <- 1:(dim(values_ischaemic_stroke)[2])

####################################################################################

# logistic regression adjusting for age (in 5-year groups), region, sex, smoking_category, education
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_ischaemic_stroke[,i] + age_cat5 + as.factor(region_code) + is_female + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8), data = ischaemic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_ischaemic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(ischaemic_stroke[which(!is.na(apply(data.frame(values_ischaemic_stroke[,i], as.numeric(ischaemic_stroke$age_cat5), ischaemic_stroke$region_code, as.numeric(ischaemic_stroke$is_female), as.numeric(ischaemic_stroke$smoking_category)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])
row.names(fit_df) <- lapply(common_data, function(x) as.character(x[[3]][[2]][1]))

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))
# save(fit_df, file = "lr_IS_metab_common_adj_age5_region_sex_smoking_education_fasting_25oct16.RData")
# write.csv(format(fit_df, digits = 2), file = "lr_IS_metab_common_adj_age5_region_sex_smoking_education_fasting_25oct16.csv")

kable(data.frame("IS" = "metabolomics"))
kable(fit_df, digits = 2)

####################################################################################
# biochemistry
####################################################################################

# standardize values such that odds ratios are for each increase in one standard deviation
values_ischaemic_stroke <- do.call(cbind, lapply(common_data, function(x) {x <- x[[1]][which(data$status == "IS" | data$status == "control")]; x/sd(x, na.rm = TRUE)}))

b <- 1:(dim(values_ischaemic_stroke)[2])

####################################################################################

# logistic regression adjusting for age (in 5-year groups), region, sex, smoking_category, education
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_ischaemic_stroke[,i] + age_cat5 + as.factor(region_code) + is_female + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8), data = ischaemic_stroke, family = "binomial"))
	names(fit)[i] <- colnames(values_ischaemic_stroke)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(ischaemic_stroke[which(!is.na(apply(data.frame(values_ischaemic_stroke[,i], as.numeric(ischaemic_stroke$age_cat5), ischaemic_stroke$region_code, as.numeric(ischaemic_stroke$is_female), as.numeric(ischaemic_stroke$smoking_category)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])
row.names(fit_df) <- lapply(common_data, function(x) as.character(x[[3]][[1]][1]))

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))
# save(fit_df, file = "lr_IS_biochem_common_adj_age5_region_sex_smoking_education_fasting_25oct16.RData")
# write.csv(format(fit_df, digits = 2), file = "lr_IS_biochem_common_adj_age5_region_sex_smoking_education_fasting_25oct16.csv")

kable(data.frame("IS" = "biochemistry"))
kable(fit_df, digits = 2)

####################################################################################
# myocardial infarction
####################################################################################

myocardial_infarction <- data[which(data$status == "MI" | data$status == "control"),]
myocardial_infarction$case <- NA
myocardial_infarction$case[which(myocardial_infarction$status == "control")] <- 0
myocardial_infarction$case[which(myocardial_infarction$status == "MI")] <- 1
table(myocardial_infarction$case, useNA = "ifany")

####################################################################################
# metabolomics
####################################################################################

# standardize values such that odds ratios are for each increase in one standard deviation
values_myocardial_infarction <- do.call(cbind, lapply(common_data, function(x) {x <- x[[2]][which(data$status == "MI" | data$status == "control")]; x/sd(x, na.rm = TRUE)}))

b <- 1:(dim(values_myocardial_infarction)[2])

####################################################################################

# logistic regression adjusting for age (in 5-year groups), region, sex, smoking_category, education
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_myocardial_infarction[,i] + age_cat5 + as.factor(region_code) + is_female + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8), data = myocardial_infarction, family = "binomial"))
	names(fit)[i] <- colnames(values_myocardial_infarction)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(myocardial_infarction[which(!is.na(apply(data.frame(values_myocardial_infarction[,i], as.numeric(myocardial_infarction$age_cat5), myocardial_infarction$region_code, as.numeric(myocardial_infarction$is_female), as.numeric(myocardial_infarction$smoking_category)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])
row.names(fit_df) <- lapply(common_data, function(x) as.character(x[[3]][[2]][1]))

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))
# save(fit_df, file = "lr_MI_metab_common_adj_age5_region_sex_smoking_education_fasting_25oct16.RData")
# write.csv(format(fit_df, digits = 2), file = "lr_MI_metab_common_adj_age5_region_sex_smoking_education_fasting_25oct16.csv")

kable(data.frame("MI" = "metabolomics"))
kable(fit_df, digits = 2)

####################################################################################
# biochemistry
####################################################################################

# standardize values such that odds ratios are for each increase in one standard deviation
values_myocardial_infarction <- do.call(cbind, lapply(common_data, function(x) {x <- x[[1]][which(data$status == "MI" | data$status == "control")]; x/sd(x, na.rm = TRUE)}))

b <- 1:(dim(values_myocardial_infarction)[2])

####################################################################################

# logistic regression adjusting for age (in 5-year groups), region, sex, smoking_category, education
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_myocardial_infarction[,i] + age_cat5 + as.factor(region_code) + is_female + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8), data = myocardial_infarction, family = "binomial"))
	names(fit)[i] <- colnames(values_myocardial_infarction)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(myocardial_infarction[which(!is.na(apply(data.frame(values_myocardial_infarction[,i], myocardial_infarction$region_code, as.numeric(myocardial_infarction$is_female), as.numeric(myocardial_infarction$smoking_category)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])
row.names(fit_df) <- lapply(common_data, function(x) as.character(x[[3]][[1]][1]))

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))
# save(fit_df, file = "lr_MI_biochem_common_adj_age5_region_sex_smoking_education_fasting_25oct16.RData")
# write.csv(format(fit_df, digits = 2), file = "lr_MI_biochem_common_adj_age5_region_sex_smoking_education_fasting_25oct16.csv")

kable(data.frame("MI" = "biochemistry"))
kable(fit_df, digits = 2)
```

```{r, eval = FALSE}
####################################################################################
# forestplots
####################################################################################

# load Jasper
source("J:/NDPH/from K drive/NDPHopen/Stats user area/Jasper/jasper/load_v2.r")

# go through all files with results and convert them to the right format with biomarker categories
filenames <- dir(pattern = "25oct16.csv")

for (ii in 1:length(filenames)) {

	results <- read.csv(filenames[ii])
	results$n_cases_controls <- paste(results$n_cases, results$n_controls, sep = "/")
	results[,2:(dim(results)[2] - 1)] <- sapply(results[,2:(dim(results)[2] - 1)], as.numeric)

	# convert them to jasper format
	results$lci <- exp(results$estimate - (1.96 * results$se))
	results$uci <- exp(results$estimate + (1.96 * results$se))
	results <- results[,c("X", "n_cases_controls", "OR", "lci", "uci")]
	names(results)[1] <- "Heading"
	names(results)[2] <- "N"
	names(results)[3] <- "HR1"
	names(results)[4:5] <- c("LCI1", "UCI1")
	write.csv(results, "temporary_csv_file_for_forestplot_28sep15.csv", row.names = FALSE) ##
	rm(results)

	# create forestplot using Jasper
	ForestFromCSV("temporary_csv_file_for_forestplot_28sep15.csv", orient = "PORTRAIT", type = "PDF", StopIfCodeExists = FALSE, filestem = paste("forestplot", strsplit(filenames[ii], ".csv")[[1]][1], tolower(format(Sys.time(), "%d%b%y_%H%M")), sep = "_"), mainfont = 1, plot.width = 30, forest.Range = c(0.5, 2.5), forest.xticks = c(0.5, 1, 1.5, 2.0, 2.5), mainTitle = paste("Odds ratios (95% CI) per standard deviation for", gsub("biochem", "- biochemistry", gsub("metab", "- metabolomics", gsub("common", "", gsub("_", " ", substr(filenames[ii], 4, regexpr("_adj", filenames[ii]) - 1))))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filenames[ii], regexpr("_adj_", filenames[ii]) + 5, regexpr("oct", filenames[ii]) - 3))))))), LogScale = TRUE, DataLogged = FALSE, ValueLabelsHeader = "OR (95% CI)", xlab = "Odds ratio (95% CI)")

	}

# , optimise.line.spacing = FALSE, optimise.fontsize = FALSE, auto.shrink.font = FALSE

####################################################################################
```

<!--
15dec16
-->

```{r, eval = FALSE}
# Figure 1: Association of traits measured by clinical biochemistry and NMR spectroscopy with risk of myocardial infarction.

####################################################################################
# myocardial infarction
####################################################################################

myocardial_infarction <- data[which(data$status == "MI" | data$status == "control"),]
myocardial_infarction$case <- NA
myocardial_infarction$case[which(myocardial_infarction$status == "control")] <- 0
myocardial_infarction$case[which(myocardial_infarction$status == "MI")] <- 1
table(myocardial_infarction$case, useNA = "ifany")

####################################################################################
# metabolomics
####################################################################################

# standardize values such that odds ratios are for each increase in one standard deviation
values_myocardial_infarction <- do.call(cbind, lapply(common_data, function(x) {x <- x[[2]][which(data$status == "MI" | data$status == "control")] / sd(x[[2]], na.rm = TRUE); return(x)}))

# values_myocardial_infarction <- do.call(cbind, lapply(common_data, function(x) {x <- x[[2]][which(data$status == "MI" | data$status == "control")] / sd_overall[names(x[2])]; return(x)}))

b <- 1:(dim(values_myocardial_infarction)[2])

####################################################################################

# logistic regression adjusting for age (in 5-year groups), region, sex, smoking_category, education
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_myocardial_infarction[,i] + age_cat5 + as.factor(region_code) + is_female + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8), data = myocardial_infarction, family = "binomial"))
	names(fit)[i] <- colnames(values_myocardial_infarction)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(myocardial_infarction[which(!is.na(apply(data.frame(values_myocardial_infarction[,i], as.numeric(myocardial_infarction$age_cat5), myocardial_infarction$region_code, as.numeric(myocardial_infarction$is_female), as.numeric(myocardial_infarction$smoking_category)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])
row.names(fit_df) <- lapply(common_data, function(x) as.character(x[[3]][[2]][1]))

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))
# save(fit_df, file = "lr_MI_metab_common_adj_age5_region_sex_smoking_education_fasting_15dec16.RData")
# write.csv(format(fit_df, digits = 2), file = "lr_MI_metab_common_adj_age5_region_sex_smoking_education_fasting_15dec16.csv")

kable(data.frame("MI" = "metabolomics"))
kable(fit_df, digits = 2)

####################################################################################
# biochemistry
####################################################################################

# standardize values such that odds ratios are for each increase in one standard deviation
values_myocardial_infarction <- do.call(cbind, lapply(common_data, function(x) {x <- x[[1]][which(data$status == "MI" | data$status == "control")] / sd(x[[1]], na.rm = TRUE); return(x)}))

b <- 1:(dim(values_myocardial_infarction)[2])

####################################################################################

# logistic regression adjusting for age (in 5-year groups), region, sex, smoking_category, education
fit <- list()
for (i in 1:length(b)) {
	fit[[i]] <- summary(glm(case ~ values_myocardial_infarction[,i] + age_cat5 + as.factor(region_code) + is_female + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8), data = myocardial_infarction, family = "binomial"))
	names(fit)[i] <- colnames(values_myocardial_infarction)[i]
	}

numbers <- list()
for (i in 1:length(b)) {
	numbers[[i]] <- table(myocardial_infarction[which(!is.na(apply(data.frame(values_myocardial_infarction[,i], myocardial_infarction$region_code, as.numeric(myocardial_infarction$is_female), as.numeric(myocardial_infarction$smoking_category)), 1, sum))),]$case)
	}

fit_df <- do.call(rbind, lapply(fit, function(x) x$coef[2,]))
fit_df <- data.frame(fit_df)
fit_df$OR <- exp(fit_df$Estimate)
fit_df <- fit_df[,c(1, 5, 2:4)]
names(fit_df) <- c("estimate", "OR", "se", "z", "p")
fit_df$n_cases <- lapply(numbers, function(x) x[2])
fit_df$n_controls <- lapply(numbers, function(x) x[1])
row.names(fit_df) <- lapply(common_data, function(x) as.character(x[[3]][[1]][1]))

fit_df$p_adj_Bonferroni <- p.adjust(fit_df$p, method = "bonferroni")
fit_df$p_adj_BH <- p.adjust(fit_df$p, method = "BH")
fit_df$p_adj_Bonf_PCA <- sapply(fit_df$p * 18, function(x) min(1, x))
# save(fit_df, file = "lr_MI_biochem_common_adj_age5_region_sex_smoking_education_fasting_15dec16.RData")
# write.csv(format(fit_df, digits = 2), file = "lr_MI_biochem_common_adj_age5_region_sex_smoking_education_fasting_15dec16.csv")

kable(data.frame("MI" = "biochemistry"))
kable(fit_df, digits = 2)

####################################################################################
# forestplots
####################################################################################

# change names, remove units, change order, same size boxes, axes from 0.75 to 1.5

# load Jasper
source("J:/NDPH/from K drive/NDPHopen/Stats user area/Jasper/jasper/load_v2.r")

filenames <- dir(pattern = "15dec16.csv")[1:2] # remove [1:2] to see all files that may be relevant

for (ii in 1:length(filenames)) {

	results <- read.csv(filenames[ii])
	results$n_cases_controls <- paste(results$n_cases, results$n_controls, sep = "/")
	results[,2:(dim(results)[2] - 1)] <- sapply(results[,2:(dim(results)[2] - 1)], as.numeric)

	# convert them to jasper format
	results$lci <- exp(results$estimate - (1.96 * results$se))
	results$uci <- exp(results$estimate + (1.96 * results$se))
	results <- results[,c("X", "n_cases_controls", "OR", "lci", "uci")]
	names(results)[1] <- "Heading"
	names(results)[2] <- "N"
	names(results)[3] <- "HR1"
	names(results)[4:5] <- c("LCI1", "UCI1")
	# change order
	results <- results[c(1, 3:4, 2, 6, 5, 7, 8),]
	# change labels
	results$Heading <- c("Total cholesterol", "LDL-C", "HDL-C", "Triglycerides", "Apolipoprotein B", "Apolipoprotein A-1", "Creatinine", "Albumin")
	results$ColHeadings <- c("N=Number\n(Cases/Controls)", rep(NA, 7))
	
	write.csv(results, "temporary_csv_file_for_forestplot_28sep15.csv", row.names = FALSE) ##
	rm(results)

	# create forestplot using Jasper
	ForestFromCSV("temporary_csv_file_for_forestplot_28sep15.csv", orient = "PORTRAIT", type = "PDF", StopIfCodeExists = FALSE, filestem = paste("forestplot", strsplit(filenames[ii], ".csv")[[1]][1], tolower(format(Sys.time(), "%d%b%y_%H%M")), sep = "_"), mainfont = 1, plot.width = 30, forest.Range = c(0.75, 1.5), forest.xticks = c(0.75, 1, 1.25, 1.5), mainTitle = paste("Odds ratios (95% CI) per standard deviation for", gsub("biochem", "- biochemistry", gsub("metab", "- metabolomics", gsub("common", "", gsub("_", " ", substr(filenames[ii], 4, regexpr("_adj", filenames[ii]) - 1))))), "\nadjusted for", gsub("age3", "age (in 3 groups)", gsub("age5", "age (in 5-year groups)", gsub("age10", "age (in 10-year groups)", gsub("_", ", ", gsub("_by_", " by ", substr(filenames[ii], regexpr("_adj_", filenames[ii]) + 5, regexpr("dec", filenames[ii]) - 4))))))), LogScale = TRUE, DataLogged = FALSE, ValueLabelsHeader = "OR (95% CI)", xlab = "OR (95% CI) per SD", boxsizeoverride = TRUE, boxparm.stderr = 0.75)

	}
```

## Correlation in duplicates

```{r}
load("../metabolomics/metabolomics_data_9sep15.RData")

## 21jun16
dim(metabolomics) # 4983  235

# check duplicates
# metabolomics[which(metabolomics$cryovialsetid %in% metabolomics$cryovialsetid[duplicated(metabolomics$cryovialsetid)]), 1:3]
# split(x, x$cryovialsetid)

# ascertainment from Iona
ascertainment <- read.csv("biochemistry_ascertainments.csv", skip = 0, na.strings = "")
names(ascertainment)[4] <- "type"

data_metabolomics <- merge(metabolomics, ascertainment, by.x = "cryovialsetid", by.y = "d_cryovialsetid", all.x = TRUE)
dim(data_metabolomics) # 4983  238

# create 'wide' data_metabolomics
data_metabolomics_baseline <- data_metabolomics[-grep("resurvey", data_metabolomics$type, ignore.case = TRUE),]
data_metabolomics_resurvey1 <- data_metabolomics[which(data_metabolomics$type == "RESURVEY1"),]
data_metabolomics_resurvey2 <- data_metabolomics[which(data_metabolomics$type == "RESURVEY2"),]

dim(data_metabolomics_baseline) # 4848  238
dim(data_metabolomics_resurvey1) # 43 238
dim(data_metabolomics_resurvey2) # 92 238

data_metabolomics_baseline$has_metabolomics <- 1
data_metabolomics_resurvey1$has_metabolomics <- 1
data_metabolomics_resurvey2$has_metabolomics <- 1

# check - duplicates?
length(data_metabolomics_baseline$studyid) # 4848
length(unique(data_metabolomics_baseline$studyid)) # 4711

table(data_metabolomics_baseline$studyid)[which(table(data_metabolomics_baseline$studyid) > 1)]

length(which(duplicated(data_metabolomics_baseline$studyid))) # 137

# create indicator for duplicated studyids
data_metabolomics_baseline$duplicated_metab_baseline <- 0
data_metabolomics_baseline[which(duplicated(data_metabolomics_baseline$studyid)),]$duplicated_metab_baseline <- 1

# table(data_metabolomics_baseline$duplicated_metab_baseline)
dupl <- data_metabolomics_baseline[which(data_metabolomics_baseline$studyid %in% data_metabolomics_baseline[which(data_metabolomics_baseline$duplicated_metab_baseline == 1),]$studyid),]
dim(dupl) # 274 240
dupl <- dupl[order(dupl$studyid),]
# check
# length(which(dupl[which(dupl$duplicated_metab_baseline == 0), "studyid"] != dupl[which(dupl$duplicated_metab_baseline == 1), "studyid"])) # 0
cor_dupl <- data.frame("Correlation" = apply(dupl[,11:235], 2, function(x) cor(x[which(dupl$duplicated_metab_baseline == 0)], x[which(dupl$duplicated_metab_baseline == 1)], use = "complete.obs")))
# write.csv(cor_dupl, file = "cor_dupl_5oct16.csv")

kable(cor_dupl, digits = 2)
```

```{r, eval = FALSE}
# table of baseline characteristics

dim(data)

data$age_3 <- cut(data$age_at_study_date, c(30, 60, 70, 80), right = FALSE)
table(data$age_3, useNA = "ifany")
# [30,60) [60,70) [70,80) 
#    4406     244      12 
 
data$educ_6years <- NA
data$educ_6years[which(data$education_combined == "1_No formal school / Primary school")] <- 0
data$educ_6years[which(data$education_combined != "1_No formal school / Primary school")] <- 1
table(data$educ_6years, useNA = "ifany")
#    0    1 
# 2062 2600 

data$met_3 <- cut(data$met, c(0, 10, 15, 100), right = FALSE)
table(data$met_3, useNA = "ifany")
#  [0,10)  [10,15) [15,100) 
#     897      828     2937 
    
data$sbp_3 <- cut(data$sbp_mean, c(0, 120, 140, 300), right = FALSE)
table(data$sbp_3, useNA = "ifany")
#  [0,120) [120,140) [140,300) 
#     1232      1612      1818 
    
data$bmi_3 <- cut(data$bmi_calc, c(0, 22, 25, 100), right = FALSE)
table(data$bmi_3, useNA = "ifany")
#  [0,22)  [22,25) [25,100) 
#    1441     1479     1742 

data$hours_since_meal_3 <- cut(data$hours_since_last_ate_x10.x, c(0, 5, 10, 50), right = FALSE)
table(data$hours_since_meal_3, useNA = "ifany")
#  [0,5)  [5,10) [10,50) 
#   3779     217     666 

data$smoking_combined <- cut(data$smoking_category, c(1, 3, 4, 5), right = FALSE)
levels(data$smoking_combined) <- c("Never regular", "Ex regular", "Current regular")
table(data$smoking_combined)
#  Never regular      Ex regular Current regular 
#           2812             228            1622 

data$alcohol_combined <- NA
data$alcohol_combined[which(data$alcohol_category == 1 | data$alcohol_category == 3)] <- "Never regular drinker"
data$alcohol_combined[which(data$alcohol_category == 2 | data$alcohol_category == 5)] <- "Ex regular drinker"
data$alcohol_combined[which(data$alcohol_category == 4 | data$alcohol_category == 6)] <- "Regular drinker"
table(data$alcohol_combined)
#   Ex regular drinker Never regular drinker       Regular drinker 
#                  202                  3400                  1060 

data$waist_cat <- cut(data$waist_mm, c(0, 700, 900, 2000), right = FALSE)
table(data$waist_cat, useNA = "ifany")
#    [0,700)   [700,900) [900,2e+03) 
#        564        3137         961 

data$met_cat <- cut(data$met, c(0, 5, 10, 25), right = FALSE)
table(data$met_cat, useNA = "ifany")
#  [0,5)  [5,10) [10,25) 
#   1552    2220     890 
       
data$ldl_cat <- cut(data$ldl_result_x10000, c(0, 2, 3, 10), right = FALSE)
table(data$ldl_cat, useNA = "ifany")
# [0,2)  [2,3) [3,10) 
#  1707   2283    672 

data$hdl_cat <- cut(data$hdl_result_x10000, c(0, 1, 2, 4), right = FALSE)
table(data$hdl_cat, useNA = "ifany")
# [0,1) [1,2) [2,4) 
#  1092  3506    64 

data$tg_cat <- cut(data$tg_result_x10000, c(0, 2, 10, 40), right = FALSE)
table(data$tg_cat, useNA = "ifany")
#  [0,2)  [2,10) [10,40) 
#   2953    1686      23 

table1 <- data.frame(rbind(c("Characteristic", "N"),
c("Age (years)", ""), as.matrix(data.frame(table(data$age_3))), c("Mean (sd)", paste(round(mean(data$age_at_study_date), 2), " (", round(sd(data$age_at_study_date), 2), ")", sep = "")),

c("Living in urban area", ""), as.matrix(data.frame(table(data$region_is_urban))),

c(">=6 years in education", ""), as.matrix(data.frame(table(data$educ_6years))),

c("Smoking history", ""), as.matrix(data.frame(table(data$smoking_combined))),

c("Alcohol consumption", ""), as.matrix(data.frame(table(data$alcohol_combined))),

c("Physical activity (MET hours/day)", ""), as.matrix(data.frame(table(data$met_3))), c("Mean (sd)", paste(round(mean(data$met), 2), " (", round(sd(data$met), 2), ")", sep = "")),

c("Systolic blood pressure (mmHg)", ""), as.matrix(data.frame(table(data$sbp_3))), c("Mean (sd)", paste(round(mean(data$sbp_mean), 2), " (", round(sd(data$sbp_mean), 2), ")", sep = "")),

c("BMI (kg/m\u00B2)", ""), as.matrix(data.frame(table(data$bmi_3))), c("Mean (sd)", paste(round(mean(data$bmi_calc), 2), " (", round(sd(data$bmi_calc), 2), ")", sep = "")),

c("Prevalent diabetes", ""), as.matrix(data.frame(table(data$has_diabetes))), c("Random glucose (sd)", paste(round(mean(data$test_random_glucose_x10, na.rm = TRUE), 2), " (", round(sd(data$test_random_glucose_x10, na.rm = TRUE), 2), ")", sep = "")),

c("Time since last ate (hours)", ""), as.matrix(data.frame(table(data$hours_since_meal_3))), c("Mean (sd)", paste(round(mean(data$hours_since_last_ate_x10.x), 2), " (", round(sd(data$hours_since_last_ate_x10.x), 2), ")", sep = "")),

c("Waist circumference (mm)", ""), as.matrix(data.frame(table(data$waist_cat))), c("Mean (sd)", paste(round(mean(data$waist_mm), 2), " (", round(sd(data$waist_mm), 2), ")", sep = "")),

c("MET", ""), as.matrix(data.frame(table(data$met_cat))), c("Mean (sd)", paste(round(mean(data$met_hours), 2), " (", round(sd(data$met_hours), 2), ")", sep = "")),

c("Height", ""), as.matrix(data.frame(table(data$met_cat))), c("Mean (sd)", paste(round(mean(data$standing_height_mm / 1000), 2), " (", round(sd(data$standing_height_mm / 1000), 2), ")", sep = "")),

c("LDL (mmol/L)", ""), as.matrix(data.frame(table(data$ldl_cat))), c("Mean (sd)", paste(round(mean(data$ldl_result_x10000), 2), " (", round(sd(data$ldl_result_x10000), 2), ")", sep = "")),

c("HDL (mmol/L)", ""), as.matrix(data.frame(table(data$hdl_cat))), c("Mean (sd)", paste(round(mean(data$hdl_result_x10000), 2), " (", round(sd(data$hdl_result_x10000), 2), ")", sep = "")),

c("Triglycerides (mmol/L)", ""), as.matrix(data.frame(table(data$tg_cat))), c("Mean (sd)", paste(round(mean(data$tg_result_x10000), 2), " (", round(sd(data$tg_result_x10000), 2), ")", sep = ""))
))

# write.csv(table1, file = paste("table_", "baseline_", tolower(format(Sys.time(), "%d%b%y_%H%M")), ".csv", sep = "")) ##

###############################################

# version 2

load("../sleep/categorical_variables_vector_18july15.RData")
load("../sleep/categorical_variables_labels_list_18july15.RData")

variables[length(variables) + 1] <- "hours_since_meal_3"
labels[[length(labels) + 1]] <- list("Hours since last meal", levels(data$hours_since_meal_3))

data$age_cat2 <- cut(data$age_at_study_date, c(30, 40, 50, 60, 80), right = FALSE)
table(data$age_cat2)
# [30,40) [40,50) [50,60) [60,80) 
#    1102    1934    1370     256 

variables[length(variables) + 1] <- "age_cat2"
labels[[length(labels) + 1]] <- list("Age", levels(data$age_cat2))

variables[length(variables) + 1] <- "waist_cat"
labels[[length(labels) + 1]] <- list("Waist circumference (mm)", levels(data$waist_cat))

variables[length(variables) + 1] <- "met_cat"
labels[[length(labels) + 1]] <- list("MET (hours)", levels(data$met_cat))

variables[length(variables) + 1] <- "ldl_cat"
labels[[length(labels) + 1]] <- list("LDL (mmol/L)", levels(data$ldl_cat))

variables[length(variables) + 1] <- "hdl_cat"
labels[[length(labels) + 1]] <- list("HDL (mmol/L)", levels(data$hdl_cat))

variables[length(variables) + 1] <- "tg_cat"
labels[[length(labels) + 1]] <- list("Triglycerides (mmol/L)", levels(data$tg_cat))

index <- c(1, 2, 3, 142, 141, 123, 127, 128, 41, 120, 132, 47, 143:147)
# index <- c(1, 2, 3, 4, 123, 127, 128, 41, 120, 121, 132, 140)

data$sbp_cat <- data$sbp_3
data$bmi_cat2 <- data$bmi_3
data$all <- 1

labels[[120]][[2]] <- levels(data$sbp_cat)
labels[[132]][[2]] <- levels(data$bmi_cat2)

source("../R functions/standardised_prop_by_factor_21jan16.r")
# source("../blood biochemistry/standardised_prop_by_factor_17july15.r")

# table with row percentages adjusted for age, region, sex
table1 <- standardised_prop_by_factor(dataset = data, outcome_variable = "status", categorical_vars = variables[index], outcome_label = list("Status", levels(as.factor(data$status))), categorical_var_labels = labels[index], adjustment_vars = c("age_cat2", "is_female", "region_code"), adjustment_var_labels = c("age", "sex", "region"), title = "")

# write.csv(table1, file = paste("table_", "baseline", "_row_adj_age_region_sex_", tolower(format(Sys.time(), "%d%b%y_%H%M")), ".csv", sep = "")) ##
# save(table1, file = paste("table_", "baseline", "_row_adj_age_region_sex_", tolower(format(Sys.time(), "%d%b%y_%H%M")), ".RData", sep = "")) ##

# 14dec16
# self-rated health poor (self_rated_health == 3)
data$self_rated_health_poor <- as.numeric(data$self_rated_health == 3)
table(data$self_rated_health_poor, data$self_rated_health, useNA = "ifany")

# library(DirectStandardisation)
# adjprop(dataset = data, outcome_var_name = "status", categorical_vars = "self_rated_health_poor", outcome_label = list("Status", levels(as.factor(data$status))), categorical_var_labels = list(list("Poor self-rated health", c("No", "Yes"))), adjustment_vars = c("age_cat2", "is_female", "region_code"), adjustment_var_labels = c("age", "sex", "region"), title = "")

# adjprop(dataset, outcome_var_name, categorical_vars, outcome_label, categorical_var_labels, adjustment_vars = c("age", "sex"), adjustment_var_labels = c("age", "sex"), title = "")

table1 <- standardised_prop_by_factor(dataset = data, outcome_variable = "status", categorical_vars = "self_rated_health_poor", outcome_label = list("Status", levels(as.factor(data$status))), categorical_var_labels = list(list("Poor self-rated health", c("No", "Yes"))), adjustment_vars = c("age_cat2", "is_female", "region_code"), adjustment_var_labels = c("age", "sex", "region"), title = "")

#                                            Variable Levels    N control (%) HS (%) IS (%) MI (%)
# 1                                                                                               
# 2                                                                      1466   1138   1146    912
# 3                            Poor self-rated health     No 4083        32.7   24.1   24.1   19.1
# 4                                                      Yes  579        23.5   26.4   26.5   20.6
# 5 Adjusted by age, sex, region (where appropriate).  

###############################################

# version 3 - unstandardised column percentages

load("../sleep/categorical_variables_vector_18july15.RData")
load("../sleep/categorical_variables_labels_list_18july15.RData")

variables[length(variables) + 1] <- "hours_since_meal_3"
labels[[length(labels) + 1]] <- list("Hours since last meal", levels(data$hours_since_meal_3))

data$age_cat2 <- cut(data$age_at_study_date, c(30, 40, 50, 60, 80), right = FALSE)
table(data$age_cat2)
# [30,40) [40,50) [50,60) [60,80) 
#    1102    1934    1370     256 

variables[length(variables) + 1] <- "age_cat2"
labels[[length(labels) + 1]] <- list("Age", levels(data$age_cat2))

index <- c(1, 2, 3, 142, 141, 123, 127, 128, 41, 120, 132, 47)
# index <- c(1, 2, 3, 4, 123, 127, 128, 41, 120, 121, 132, 140)

data$sbp_cat <- data$sbp_3
data$bmi_cat2 <- data$bmi_3
data$all <- 1

labels[[120]][[2]] <- levels(data$sbp_cat)
labels[[132]][[2]] <- levels(data$bmi_cat2)

source("../R functions/unstandardised_column_prop_by_factor_18july15.r")

# table with unadjusted column percentages
table1 <- unstandardised_prop_by_factor(dataset = data, outcome_variable = "status", categorical_variables = variables[index], outcome_label = list("Status", levels(as.factor(data$status))), categorical_var_labels = labels[index])

write.csv(table1, file = paste("table_", "baseline", "_column_", tolower(format(Sys.time(), "%d%b%y_%H%M")), ".csv", sep = "")) ##
save(table1, file = paste("table_", "baseline", "_column_", tolower(format(Sys.time(), "%d%b%y_%H%M")), ".RData", sep = "")) ##

# 14dec16
# self-rated health poor (self_rated_health == 3)
data$self_rated_health_poor <- as.numeric(data$self_rated_health == 3)
table(data$self_rated_health_poor, data$self_rated_health, useNA = "ifany")

table1 <- unstandardised_prop_by_factor(dataset = data, outcome_variable = "status", categorical_variables = "self_rated_health_poor", outcome_label = list("Status", levels(as.factor(data$status))), categorical_var_labels = list(list("Poor self-rated health", c("No", "Yes"))))
#                 Variable Levels    N control (%) HS (%) IS (%) MI (%)
# 1 Poor self-rated health     No 4083        91.4   85.8   87.5   83.8
# 2                           Yes  579         8.6   14.2   12.5   16.2

## additional variables

table1b <- data.frame(rbind(# c("Characteristic", "Mean (sd)"),
c("Age (years)", paste(round(mean(data$age_at_study_date), 2), " (", round(sd(data$age_at_study_date), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "control"),]$age_at_study_date), 2), " (", round(sd(data[which(data$status == "control"),]$age_at_study_date), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "HS"),]$age_at_study_date), 2), " (", round(sd(data[which(data$status == "HS"),]$age_at_study_date), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "IS"),]$age_at_study_date), 2), " (", round(sd(data[which(data$status == "IS"),]$age_at_study_date), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "MI"),]$age_at_study_date), 2), " (", round(sd(data[which(data$status == "MI"),]$age_at_study_date), 2), ")", sep = "")),

c("Systolic blood pressure (mmHg)", paste(round(mean(data$sbp_mean), 2), " (", round(sd(data$sbp_mean), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "control"),]$sbp_mean), 2), " (", round(sd(data[which(data$status == "control"),]$sbp_mean), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "HS"),]$sbp_mean), 2), " (", round(sd(data[which(data$status == "HS"),]$sbp_mean), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "IS"),]$sbp_mean), 2), " (", round(sd(data[which(data$status == "IS"),]$sbp_mean), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "MI"),]$sbp_mean), 2), " (", round(sd(data[which(data$status == "MI"),]$sbp_mean), 2), ")", sep = "")),

c("Diastolic blood pressure (mmHg)", paste(round(mean(data$dbp_mean), 2), " (", round(sd(data$dbp_mean), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "control"),]$dbp_mean), 2), " (", round(sd(data[which(data$status == "control"),]$dbp_mean), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "HS"),]$dbp_mean), 2), " (", round(sd(data[which(data$status == "HS"),]$dbp_mean), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "IS"),]$dbp_mean), 2), " (", round(sd(data[which(data$status == "IS"),]$dbp_mean), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "MI"),]$dbp_mean), 2), " (", round(sd(data[which(data$status == "MI"),]$dbp_mean), 2), ")", sep = "")),

c("BMI (kg/m\u00B2)", paste(round(mean(data$bmi_calc), 2), " (", round(sd(data$bmi_calc), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "control"),]$bmi_calc), 2), " (", round(sd(data[which(data$status == "control"),]$bmi_calc), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "HS"),]$bmi_calc), 2), " (", round(sd(data[which(data$status == "HS"),]$bmi_calc), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "IS"),]$bmi_calc), 2), " (", round(sd(data[which(data$status == "IS"),]$bmi_calc), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "MI"),]$bmi_calc), 2), " (", round(sd(data[which(data$status == "MI"),]$bmi_calc), 2), ")", sep = "")),

c("Time since last ate (hours)", paste(round(mean(data$hours_since_last_ate_x10.x), 2), " (", round(sd(data$hours_since_last_ate_x10.x), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "control"),]$hours_since_last_ate_x10.x), 2), " (", round(sd(data[which(data$status == "control"),]$hours_since_last_ate_x10.x), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "HS"),]$hours_since_last_ate_x10.x), 2), " (", round(sd(data[which(data$status == "HS"),]$hours_since_last_ate_x10.x), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "IS"),]$hours_since_last_ate_x10.x), 2), " (", round(sd(data[which(data$status == "IS"),]$hours_since_last_ate_x10.x), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "MI"),]$hours_since_last_ate_x10.x), 2), " (", round(sd(data[which(data$status == "MI"),]$hours_since_last_ate_x10.x), 2), ")", sep = "")),

c("Time since last ate (hours) - median (IQR)", paste(round(median(data$hours_since_last_ate_x10.x), 2), " (", round(IQR(data$hours_since_last_ate_x10.x), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "control"),]$hours_since_last_ate_x10.x), 2), " (", round(IQR(data[which(data$status == "control"),]$hours_since_last_ate_x10.x), 2), ")", sep = ""),
paste(round(median(data[which(data$status == "HS"),]$hours_since_last_ate_x10.x), 2), " (", round(IQR(data[which(data$status == "HS"),]$hours_since_last_ate_x10.x), 2), ")", sep = ""),
paste(round(median(data[which(data$status == "IS"),]$hours_since_last_ate_x10.x), 2), " (", round(IQR(data[which(data$status == "IS"),]$hours_since_last_ate_x10.x), 2), ")", sep = ""),
paste(round(median(data[which(data$status == "MI"),]$hours_since_last_ate_x10.x), 2), " (", round(IQR(data[which(data$status == "MI"),]$hours_since_last_ate_x10.x), 2), ")", sep = "")),

c("Waist circumference (mm)", paste(round(mean(data$waist_mm), 2), " (", round(sd(data$waist_mm), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "control"),]$waist_mm), 2), " (", round(sd(data[which(data$status == "control"),]$waist_mm), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "HS"),]$waist_mm), 2), " (", round(sd(data[which(data$status == "HS"),]$waist_mm), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "IS"),]$waist_mm), 2), " (", round(sd(data[which(data$status == "IS"),]$waist_mm), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "MI"),]$waist_mm), 2), " (", round(sd(data[which(data$status == "MI"),]$waist_mm), 2), ")", sep = "")),

c("Height (m)", paste(round(mean(data$standing_height_mm / 1000), 2), " (", round(sd(data$standing_height_mm / 1000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "control"),]$standing_height_mm / 1000), 2), " (", round(sd(data[which(data$status == "control"),]$standing_height_mm / 1000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "HS"),]$standing_height_mm / 1000), 2), " (", round(sd(data[which(data$status == "HS"),]$standing_height_mm / 1000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "IS"),]$standing_height_mm / 1000), 2), " (", round(sd(data[which(data$status == "IS"),]$standing_height_mm / 1000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "MI"),]$standing_height_mm / 1000), 2), " (", round(sd(data[which(data$status == "MI"),]$standing_height_mm / 1000), 2), ")", sep = "")),

c("MET", paste(round(mean(data$met), 2), " (", round(sd(data$met), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "control"),]$met), 2), " (", round(sd(data[which(data$status == "control"),]$met), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "HS"),]$met), 2), " (", round(sd(data[which(data$status == "HS"),]$met), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "IS"),]$met), 2), " (", round(sd(data[which(data$status == "IS"),]$met), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "MI"),]$met), 2), " (", round(sd(data[which(data$status == "MI"),]$met), 2), ")", sep = "")),

c("LDL (mmol/L)", paste(round(mean(data$ldl_result_x10000), 2), " (", round(sd(data$ldl_result_x10000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "control"),]$ldl_result_x10000), 2), " (", round(sd(data[which(data$status == "control"),]$ldl_result_x10000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "HS"),]$ldl_result_x10000), 2), " (", round(sd(data[which(data$status == "HS"),]$ldl_result_x10000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "IS"),]$ldl_result_x10000), 2), " (", round(sd(data[which(data$status == "IS"),]$ldl_result_x10000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "MI"),]$ldl_result_x10000), 2), " (", round(sd(data[which(data$status == "MI"),]$ldl_result_x10000), 2), ")", sep = "")),

c("HDL (mmol/L)", paste(round(mean(data$hdl_result_x10000), 2), " (", round(sd(data$hdl_result_x10000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "control"),]$hdl_result_x10000), 2), " (", round(sd(data[which(data$status == "control"),]$hdl_result_x10000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "HS"),]$hdl_result_x10000), 2), " (", round(sd(data[which(data$status == "HS"),]$hdl_result_x10000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "IS"),]$hdl_result_x10000), 2), " (", round(sd(data[which(data$status == "IS"),]$hdl_result_x10000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "MI"),]$hdl_result_x10000), 2), " (", round(sd(data[which(data$status == "MI"),]$hdl_result_x10000), 2), ")", sep = "")),

c("Triglycerides (mmol/L)", paste(round(mean(data$tg_result_x10000), 2), " (", round(sd(data$tg_result_x10000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "control"),]$tg_result_x10000), 2), " (", round(sd(data[which(data$status == "control"),]$tg_result_x10000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "HS"),]$tg_result_x10000), 2), " (", round(sd(data[which(data$status == "HS"),]$tg_result_x10000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "IS"),]$tg_result_x10000), 2), " (", round(sd(data[which(data$status == "IS"),]$tg_result_x10000), 2), ")", sep = ""),
paste(round(mean(data[which(data$status == "MI"),]$tg_result_x10000), 2), " (", round(sd(data[which(data$status == "MI"),]$tg_result_x10000), 2), ")", sep = ""))
))

names(table1b) <- c("Variable", "All", "Controls", "HS", "IS", "MI")

write.csv(table1b, file = paste("table_1b_", "baseline_", tolower(format(Sys.time(), "%d%b%y_%H%M")), ".csv", sep = "")) ##
```

```{r, eval = FALSE}
# table of N, mean and SD in controls only
table_controls <- data.frame("N" = sapply(data[which(data$status == "control"), b], function(x) length(x[which(!is.na(x))])), "Mean" = sapply(data[which(data$status == "control"), b], function(x) mean(x[which(!is.na(x))])), "SD" = sapply(data[which(data$status == "control"), b], function(x) sd(x[which(!is.na(x))])))
row.names(table_controls) <- gsub("_", " ", row.names(table_controls))
# write.csv(format(table_controls, digits = 3), file = "table_controls_15dec16.csv")
```

```{r, eval = FALSE}
## HERE

####################################################################################
# ORs by quartiles
####################################################################################

####################################################################################
# metabolomics
####################################################################################

# load("myocardial_infarction_data_28sep15.RData")

library(Epi)

values_myocardial_infarction <- do.call(cbind, lapply(common_data, function(x) {x <- x[[2]][which(data$type == "MI case phase 1" | data$type == "ICH control")]}))

# values_myocardial_infarction <- do.call(cbind, lapply(common_data, function(x) {x <- x[[2]][which(data$type == "MI case phase 1" | data$type == "ICH control")]; x/sd(x, na.rm = TRUE)}))

b <- 1:(dim(values_myocardial_infarction)[2])

values <- data.frame(matrix(NA, nrow = dim(values_myocardial_infarction)[1], ncol = dim(values_myocardial_infarction)[2]))
fit <- list()
floating <- list()
for (i in 1:length(b)) {
	values[,i] <- cut(values_myocardial_infarction[,b[i]], unique(quantile(values_myocardial_infarction[,b[i]], probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)), right = FALSE, include.lowest = TRUE)
	names(values)[i] <- colnames(values_myocardial_infarction[,b])[i]
	fit[[i]] <- glm(case ~ values[,i] + age_cat5 + is_female + as.factor(region_code) + I(hours_since_last_ate_x10.x >= 8), data = myocardial_infarction, family = "binomial")
	floating[[i]] <- float(fit[[i]])
	names(fit)[i] <- names(floating)[i] <- colnames(values_myocardial_infarction)[i]
	}

fit_df <- list()
for (i in 1:length(b)) {
	fit_df[[i]] <- summary(fit[[i]])$coef[1:(grep("age_cat", row.names(summary(fit[[i]])$coef))[1] - 1),]
	fit_df[[i]] <- data.frame(fit_df[[i]])
#	fit_df[[i]]$OR <- exp(fit_df[[i]]$Estimate)
	fit_df[[i]]$OR <- exp(floating[[i]]$coef)
	fit_df[[i]]$float_se <- sqrt(floating[[i]]$var)
#	fit_df[[i]] <- fit_df[[i]][,c(1, 5, 2:4)]
	names(fit_df[[i]])[1:4] <- c("estimate", "se", "z", "p")
	fit_df[[i]]$names <- levels(values[,i])
	names(fit_df)[i] <- names(fit)[i]
	}
# save(fit_df, file = "lr_quartiles_MI_common_metab_adj_age5_sex_region_meal_18feb16.RData")

# plot

source("plot_Fiona_edited_logy_15oct15.r")

# dir.create("plots MI - OR by quartile - common")

# jpeg
for (j in 1:length(fit_df)) {
	jpeg(paste("plots MI - OR by quartile - common/plot_OR_metab_", "MI_adj_meal", "_", names(fit_df)[j], "_", tolower(format(Sys.time(), "%d%b%y_%H%M")), ".jpeg", sep = ""), width = 2*480, height = 2*480, quality = 100, res = 110) ##
	par(mar = c(5.5, 5.5, 4, 4) + 0.1)
	plotf(values = list(list("est" = fit_df[[j]]$OR, "se" = fit_df[[j]]$float_se)), x_labels = fit_df[[j]]$name, x_axis_label = common_data[[j]]$label[[2]], x_lim = NULL, y_lim = NULL, outcome_label = "Odds ratio and 95% CI", categorical_var_labels = "", plot_label = paste(gsub("_", " ", names(fit_df)[j]), "Metabolomics", sep = "\n"), legend_position = "topleft", legend_title = "", legend = FALSE) 
	dev.off()
	}

# x_axis_label = metabolomics_labels["units", names(fit_df)[j]]

# multi-page pdf
pdf(paste("plots_OR_metab_MI_common_multipage", "_", tolower(format(Sys.time(), "%d%b%y_%H%M")), ".pdf", sep = ""), height = 10, width = 10) ##
for (j in 1:length(fit_df)) {
	par(mar = c(5.5, 5.5, 4, 4) + 0.1)
	plotf(values = list(list("est" = fit_df[[j]]$OR, "se" = fit_df[[j]]$float_se)), x_labels = fit_df[[j]]$name, x_axis_label = common_data[[j]]$label[[2]], x_lim = NULL, y_lim = NULL, outcome_label = "Odds ratio and 95% CI", categorical_var_labels = "", plot_label = paste(gsub("_", " ", names(fit_df)[j]), "Metabolomics", sep = "\n"), legend_position = "topleft", legend_title = "", legend = FALSE) 
	}
dev.off()

# huge pdf
pdf(paste("plots_OR_metab_MI_common_all", "_", tolower(format(Sys.time(), "%d%b%y_%H%M")), ".pdf", sep = ""), height = 3*7, width = 3*10) ##
par(mfrow = c(3, 3), cex = 1.1, mar = c(5.5, 5.5, 4, 4) + 0.1)
for (j in 1:length(fit_df)) {
	plotf(values = list(list("est" = fit_df[[j]]$OR, "se" = fit_df[[j]]$float_se)), x_labels = fit_df[[j]]$name, x_axis_label = common_data[[j]]$label[[2]], x_lim = NULL, y_lim = NULL, outcome_label = "Odds ratio and 95% CI", categorical_var_labels = "", plot_label = paste(gsub("_", " ", names(fit_df)[j]), "Metabolomics", sep = "\n"), legend_position = "topleft", legend_title = "", legend = FALSE) 
	}
dev.off()

####################################################################################
# biochemistry
####################################################################################

# load("myocardial_infarction_data_28sep15.RData")

library(Epi)

values_myocardial_infarction <- do.call(cbind, lapply(common_data, function(x) {x <- x[[1]][which(data$type == "MI case phase 1" | data$type == "ICH control")]}))

# values_myocardial_infarction <- do.call(cbind, lapply(common_data, function(x) {x <- x[[2]][which(data$type == "MI case phase 1" | data$type == "ICH control")]; x/sd(x, na.rm = TRUE)}))

b <- 1:(dim(values_myocardial_infarction)[2])

values <- data.frame(matrix(NA, nrow = dim(values_myocardial_infarction)[1], ncol = dim(values_myocardial_infarction)[2]))
fit <- list()
floating <- list()
for (i in 1:length(b)) {
	values[,i] <- cut(values_myocardial_infarction[,b[i]], unique(quantile(values_myocardial_infarction[,b[i]], probs = c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)), right = FALSE, include.lowest = TRUE)
	names(values)[i] <- colnames(values_myocardial_infarction[,b])[i]
	fit[[i]] <- glm(case ~ values[,i] + age_cat5 + is_female + as.factor(region_code) + I(hours_since_last_ate_x10.x >= 8), data = myocardial_infarction, family = "binomial")
	floating[[i]] <- float(fit[[i]])
	names(fit)[i] <- names(floating)[i] <- colnames(values_myocardial_infarction)[i]
	}

fit_df <- list()
for (i in 1:length(b)) {
	fit_df[[i]] <- summary(fit[[i]])$coef[1:(grep("age_cat", row.names(summary(fit[[i]])$coef))[1] - 1),]
	fit_df[[i]] <- data.frame(fit_df[[i]])
#	fit_df[[i]]$OR <- exp(fit_df[[i]]$Estimate)
	fit_df[[i]]$OR <- exp(floating[[i]]$coef)
	fit_df[[i]]$float_se <- sqrt(floating[[i]]$var)
#	fit_df[[i]] <- fit_df[[i]][,c(1, 5, 2:4)]
	names(fit_df[[i]])[1:4] <- c("estimate", "se", "z", "p")
	fit_df[[i]]$names <- levels(values[,i])
	names(fit_df)[i] <- names(fit)[i]
	}
# save(fit_df, file = "lr_quartiles_MI_common_biochem_adj_age5_sex_region_meal_18feb16.RData")

# plot

source("plot_Fiona_edited_logy_15oct15.r")

# dir.create("plots MI - OR by quartile - common")

# jpeg
for (j in 1:length(fit_df)) {
	jpeg(paste("plots MI - OR by quartile - common/plot_OR_biochem_", "MI_adj_meal", "_", names(fit_df)[j], "_", tolower(format(Sys.time(), "%d%b%y_%H%M")), ".jpeg", sep = ""), width = 2*480, height = 2*480, quality = 100, res = 110) ##
	par(mar = c(5.5, 5.5, 4, 4) + 0.1)
	plotf(values = list(list("est" = fit_df[[j]]$OR, "se" = fit_df[[j]]$float_se)), x_labels = fit_df[[j]]$name, x_axis_label = common_data[[j]]$label[[2]], x_lim = NULL, y_lim = NULL, outcome_label = "Odds ratio and 95% CI", categorical_var_labels = "", plot_label = paste(gsub("_", " ", names(fit_df)[j]), "Biochemistry", sep = "\n"), legend_position = "topleft", legend_title = "", legend = FALSE) 
	dev.off()
	}

# x_axis_label = metabolomics_labels["units", names(fit_df)[j]]

# multi-page pdf
pdf(paste("plots_OR_biochem_MI_common_multipage", "_", tolower(format(Sys.time(), "%d%b%y_%H%M")), ".pdf", sep = ""), height = 10, width = 10) ##
for (j in 1:length(fit_df)) {
	par(mar = c(5.5, 5.5, 4, 4) + 0.1)
	plotf(values = list(list("est" = fit_df[[j]]$OR, "se" = fit_df[[j]]$float_se)), x_labels = fit_df[[j]]$name, x_axis_label = common_data[[j]]$label[[2]], x_lim = NULL, y_lim = NULL, outcome_label = "Odds ratio and 95% CI", categorical_var_labels = "", plot_label = paste(gsub("_", " ", names(fit_df)[j]), "Biochemistry", sep = "\n"), legend_position = "topleft", legend_title = "", legend = FALSE) 
	}
dev.off()

# huge pdf
pdf(paste("plots_OR_biochem_MI_common_all", "_", tolower(format(Sys.time(), "%d%b%y_%H%M")), ".pdf", sep = ""), height = 3*7, width = 3*10) ##
par(mfrow = c(3, 3), cex = 1.1, mar = c(5.5, 5.5, 4, 4) + 0.1)
for (j in 1:length(fit_df)) {
	plotf(values = list(list("est" = fit_df[[j]]$OR, "se" = fit_df[[j]]$float_se)), x_labels = fit_df[[j]]$name, x_axis_label = common_data[[j]]$label[[2]], x_lim = NULL, y_lim = NULL, outcome_label = "Odds ratio and 95% CI", categorical_var_labels = "", plot_label = paste(gsub("_", " ", names(fit_df)[j]), "Biochemistry", sep = "\n"), legend_position = "topleft", legend_title = "", legend = FALSE) 
	}
dev.off()

####################################################################################
####################################################################################

```

```{r, eval = FALSE}
b1 <- b[-grep("ratio ", names(data))]
grep(" ratio", names(data))

# huge pdf
pdf(paste("histograms", "_", tolower(format(Sys.time(), "%d%b%y_%H%M")), ".pdf", sep = ""), height = 3*7, width = 3*10) ##

for (i in 1:length(b)) {
	hist(data[,b[i]])
  }
dev.off()

# linear regression
fit <- list()
for (i in 1:length(b)) {
  fit[[i]] <- summary(lm(data[,b[i]] ~ met + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + bmi_calc, data = data[which(...)]))
  names(fit)[i] <- colnames(data)[b[i]]
}

# linear regression - residuals
for (i in 1:length(b)) {
  fit <- lm(data[,b[i]] ~ met + age_cat5 + is_female + as.factor(region_code) + as.factor(smoking_category) + education_combined + I(hours_since_last_ate_x10.x >= 8) + bmi_calc, data = data[which(...)])
  plot(fit$residuals, fit$fitted)
  hist(fit$residuals)
}

```

<!--
END
-->

